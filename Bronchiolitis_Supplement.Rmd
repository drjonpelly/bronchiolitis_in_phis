---
title: "Bronchiolitis Supplement"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, results = "hide"))
library(tidyverse)
library(flexdashboard)
```

```{r file loading}
reading_function <- function(csv_file) {
  read_csv(csv_file,
    col_types =
      cols(
        `Hospital Number` = col_double(),
        `Hospital City` = col_factor(),
        `Medical Record Number` = col_double(),
        `Discharge ID` = col_double(),
        `Billing Number` = col_character(),
        `Admit Date` = col_character(),
        `Admit Hour` = col_double(),
        `Admit Hour Indicator Title` = col_factor(),
        `Discharge Date` = col_character(),
        `Length Of Stay` = col_double(),
        `Priority Of Admission Title` = col_factor(),
        `Source Of Admission Title` = col_factor(),
        `Patient Type` = col_double(),
        `Patient Type Title` = col_factor(),
        `Primary Source Of Payment` = col_double(),
        `Primary Source Of Payment Title` = col_factor(),
        `Principal Dx (ICD)` = col_factor(),
        `Principal Dx Version (ICD)` = col_double(),
        `Principal Dx Title (ICD)` = col_factor(),
        `Gender Title` = col_factor(),
        `Race - American Indian` = col_factor(),
        `Race - Asian` = col_factor(),
        `Race - Black` = col_factor(),
        `Race - Other` = col_factor(),
        `Race - Pacific Islander` = col_factor(),
        `Race - White` = col_factor(),
        `Ethnicity Title` = col_factor(),
        `Admit Age In Days` = col_double(),
        `Admit Age In Months` = col_double(),
        `Complex Chronic Condition Flag` = col_factor(),
        `Cardiovascular Flag` = col_factor(),
        `Gastrointestinal Flag` = col_factor(),
        `Hematologic or Immunologic Flag` = col_factor(),
        `Malignancy Flag` = col_factor(),
        `Mental Health Disorder Flag` = col_factor(),
        `Metabolic Flag` = col_factor(),
        `Neurologic and Neuromuscular Flag` = col_factor(),
        `NICU Flag` = col_factor(),
        `Other Congenital or Genetic Defect Flag` = col_factor(),
        `Premature and Neonatal Flag` = col_factor(),
        `Renal and Urologic Flag` = col_factor(),
        `Respiratory Flag` = col_factor(),
        `Secondary Dx Mental Health Disorder Flag` = col_factor(),
        `Technology Dependent Flag` = col_factor(),
        `TPN Flag` = col_factor(),
        `Transplant Flag` = col_factor(),
        `ICU Flag` = col_factor(),
        `Total Days In ICU` = col_double(),
        `Mechanical Vent Flag` = col_factor(),
        `ECMO Flag` = col_factor(),
        `Discharge Mortality Flag` = col_factor(),
        `Disposition Title` = col_factor(),
        `Adj Abstract Based Charges` = col_character(),
        `Adj Estimated Cost` = col_character(),
        `Abstract Based Charges` = col_character(),
        `Estimated Cost` = col_character()
      )
  )
}

all_bronchiolitis_diagnoses <- reading_function("Bronchiolitis_PHIS_Reports/All_Bronchiolitis.csv")
primary_bronchiolitis_diagnoses <- reading_function("Bronchiolitis_PHIS_Reports/Bronchiolitis_Primary_Diagnosis.csv")
apr_drg_bronchiolitis <- reading_function("Bronchiolitis_PHIS_Reports/Bronchiolitis_APR-DRG_v32.csv")

# replace all spaces in names with underscores, remove special characters and double spaces, change to lowercase
names(all_bronchiolitis_diagnoses) <- names(all_bronchiolitis_diagnoses) %>%
  stringr::str_replace_all("\\s", "_") %>%
  stringr::str_replace_all("-", "") %>%
  stringr::str_replace_all("\\(", "_") %>%
  stringr::str_replace_all("\\)", "") %>%
  stringr::str_replace_all("__", "_") %>%
  tolower()

names(primary_bronchiolitis_diagnoses) <- names(primary_bronchiolitis_diagnoses) %>%
  stringr::str_replace_all("\\s", "_") %>%
  stringr::str_replace_all("-", "") %>%
  stringr::str_replace_all("\\(", "_") %>%
  stringr::str_replace_all("\\)", "") %>%
  stringr::str_replace_all("__", "_") %>%
  tolower()

names(apr_drg_bronchiolitis) <- names(apr_drg_bronchiolitis) %>%
  stringr::str_replace_all("\\s", "_") %>%
  stringr::str_replace_all("-", "") %>%
  stringr::str_replace_all("\\(", "_") %>%
  stringr::str_replace_all("\\)", "") %>%
  stringr::str_replace_all("__", "_") %>%
  tolower()

cat("The column names of your all bronchiolitis diagnoses spreadsheet are as follows: \n \n")
names(all_bronchiolitis_diagnoses)

cat("\n \nThe column names of your primary bronchiolitis diagnoses spreadsheet are as follows: \n \n")
names(primary_bronchiolitis_diagnoses)

cat("\n \nThe column names of your APR-DRG v32 bronchiolitis spreadsheet are as follows: \n \n")
names(apr_drg_bronchiolitis)
rm(reading_function)
```

```{r insurance rename function}

insurance_rename_function <- function(bronchiolitis_table) {
  temp_table <- bronchiolitis_table %>% mutate(primary_source_of_payment_title = as.character(primary_source_of_payment_title))
  temp_table <- temp_table %>% mutate(primary_source_of_payment_simplified = case_when(
    # Commercial
    primary_source_of_payment_title == "Commercial Other" ~ "Commercial",
    primary_source_of_payment_title == "Commercial HMO" ~ "Commercial",
    primary_source_of_payment_title == "Commercial PPO" ~ "Commercial",
    # Government
    primary_source_of_payment_title == "In-State Medicaid (managed care)" ~ "Government",
    primary_source_of_payment_title == "In-State Medicaid (other)" ~ "Government",
    primary_source_of_payment_title == "Out-of-State Medicaid (all)" ~ "Government",
    primary_source_of_payment_title == "TRICARE" ~ "Government",
    primary_source_of_payment_title == "Other Government" ~ "Government",
    primary_source_of_payment_title == "Medicare" ~ "Government",
    primary_source_of_payment_title == "CHIP" ~ "Government",
    # Other
    primary_source_of_payment_title == "Other Payor" ~ "Other",
    primary_source_of_payment_title == "Self Pay" ~ "Other",
    primary_source_of_payment_title == "Unknown" ~ "Other",
    primary_source_of_payment_title == "Hospital chose not to bill for this encounter" ~ "Other",
    primary_source_of_payment_title == "Charity" ~ "Other"
  ))
  temp_table <- temp_table %>% mutate(primary_source_of_payment_simplified = as.factor(primary_source_of_payment_simplified))
  return(temp_table)
}

all_bronchiolitis_diagnoses <- insurance_rename_function(all_bronchiolitis_diagnoses)
primary_bronchiolitis_diagnoses <- insurance_rename_function(primary_bronchiolitis_diagnoses)
apr_drg_bronchiolitis <- insurance_rename_function(apr_drg_bronchiolitis)

cat("The following is a summary of the simplified all bronchiolitis insurance column: \n \n")
summary(all_bronchiolitis_diagnoses$primary_source_of_payment_simplified)

cat("\n \nThe following is a summary of the simplified primary bronchiolitis insurance column: \n \n")
summary(primary_bronchiolitis_diagnoses$primary_source_of_payment_simplified)

cat("\n \nThe following is a summary of the simplified APR-DRG bronchiolitis insurance column: \n \n")
summary(apr_drg_bronchiolitis$primary_source_of_payment_simplified)

rm(insurance_rename_function)
```


```{r generate a transfer flag}
# note that this flag includes transfers from all sources (hospitals, SNF, clinic, etc)

transfer_flag_function <- function(bronchiolitis_table) {
  transfers <- grep("transfer", bronchiolitis_table$source_of_admission_title)
  transfers <- all_bronchiolitis_diagnoses[transfers, ]
  transfers$transfer_flag <- "Y"
  transfers <- transfers %>% select(discharge_id, transfer_flag)
  transfer_table <- left_join(bronchiolitis_table, transfers, by = "discharge_id")
  transfer_table <- transfer_table %>% mutate(transfer_flag = as.factor(replace_na(transfer_flag, "N")))
  return(transfer_table)
}

all_bronchiolitis_diagnoses <- transfer_flag_function(all_bronchiolitis_diagnoses)
primary_bronchiolitis_diagnoses <- transfer_flag_function(primary_bronchiolitis_diagnoses)
apr_drg_bronchiolitis <- transfer_flag_function(apr_drg_bronchiolitis)

rm(transfer_flag_function)
```

```{r generate single race factor}
race_factor_function <- function(bronchiolitis_table) {
  race_table <- bronchiolitis_table
  race_table <- race_table %>% mutate(race_factor = case_when(
    race_american_indian == "Y" & race_asian == "N" & race_black == "N" & race_other == "N" & race_pacific_islander == "N" & race_white == "N" ~ "american_indian",
    race_american_indian == "N" & race_asian == "Y" & race_black == "N" & race_other == "N" & race_pacific_islander == "N" & race_white == "N" ~ "asian",
    race_american_indian == "N" & race_asian == "N" & race_black == "Y" & race_other == "N" & race_pacific_islander == "N" & race_white == "N" ~ "black",
    race_american_indian == "N" & race_asian == "N" & race_black == "Y" & race_other == "N" & race_pacific_islander == "N" & race_white == "N" ~ "pacific_islander",
    race_american_indian == "N" & race_asian == "N" & race_black == "N" & race_other == "N" & race_pacific_islander == "N" & race_white == "Y" ~ "white",
    TRUE ~ "other"
  ))
  race_table$race_factor <- as.factor(race_table$race_factor)
  race_table$race_factor <- fct_lump(race_table$race_factor, n = 3, other_level = "other") # collapse race into white, black, other
  race_table$race_factor <- fct_infreq(race_table$race_factor) # order by frequency
  return(race_table)
}

all_bronchiolitis_diagnoses <- race_factor_function(all_bronchiolitis_diagnoses)
cat("Here is a summary of the all bronchiolitis diagnoses race factor column:\n", summary(all_bronchiolitis_diagnoses$race_factor))

primary_bronchiolitis_diagnoses <- race_factor_function(primary_bronchiolitis_diagnoses)
cat("\n\nHere is a summary of the primary bronchiolitis diagnoses race factor column:\n", summary(primary_bronchiolitis_diagnoses$race_factor))

apr_drg_bronchiolitis <- race_factor_function(apr_drg_bronchiolitis)
cat("\n\nHere is a summary of the APR-DRG v32 bronchiolitis diagnoses race factor column:\n", summary(apr_drg_bronchiolitis$race_factor))
rm(race_factor_function)
```

```{r generate discharge year column for grouping}
library(lubridate)

discharge_year_function <- function(bronchiolitis_table) {
  discharge_year_table <- bronchiolitis_table %>%
    mutate(discharge_date = mdy(discharge_date)) %>%
    mutate(discharge_year = as.numeric(format(discharge_date, "%Y")))
  return(discharge_year_table)
}

all_bronchiolitis_diagnoses <- discharge_year_function(all_bronchiolitis_diagnoses)
primary_bronchiolitis_diagnoses <- discharge_year_function(primary_bronchiolitis_diagnoses)
apr_drg_bronchiolitis <- discharge_year_function(apr_drg_bronchiolitis)

rm(discharge_year_function)
```

```{r change cost column to numeric}

cost_cleaning_function <- function(cost_column, cost_column_name) {
  cost_temp <- suppressWarnings(str_remove(cost_column, "\\$") %>% str_remove(",") %>% as.numeric())
  costs_missing <- length(subset(cost_temp, is.na(cost_temp)))
  cat("There are", costs_missing, "patients with missing cost data in", cost_column_name, "\n These values have been set to NA.\n \n")
  return(cost_temp)
}

# Apply cost cleaning to all bronchiolitis table
all_bronchiolitis_diagnoses$estimated_cost <- cost_cleaning_function(all_bronchiolitis_diagnoses$estimated_cost, "all_bronchiolitis_diagnoses$estimated_cost")

all_bronchiolitis_diagnoses$adj_estimated_cost <- cost_cleaning_function(all_bronchiolitis_diagnoses$adj_estimated_cost, "all_bronchiolitis_diagnoses$adj_estimated_cost")

all_bronchiolitis_diagnoses$abstract_based_charges <- cost_cleaning_function(all_bronchiolitis_diagnoses$abstract_based_charges, "all_bronchiolitis_diagnoses$abstract_based_charges")

all_bronchiolitis_diagnoses$adj_abstract_based_charges <- cost_cleaning_function(all_bronchiolitis_diagnoses$adj_abstract_based_charges, "all_bronchiolitis_diagnoses$adj_abstract_based_charges")


# Apply cost cleaning to primary bronchiolitis diagnosis table
primary_bronchiolitis_diagnoses$estimated_cost <- cost_cleaning_function(primary_bronchiolitis_diagnoses$estimated_cost, "primary_bronchiolitis_diagnoses$estimated_cost")

primary_bronchiolitis_diagnoses$adj_estimated_cost <- cost_cleaning_function(primary_bronchiolitis_diagnoses$adj_estimated_cost, "primary_bronchiolitis_diagnoses$adj_estimated_cost")

primary_bronchiolitis_diagnoses$abstract_based_charges <- cost_cleaning_function(primary_bronchiolitis_diagnoses$abstract_based_charges, "primary_bronchiolitis_diagnoses$abstract_based_charges")

primary_bronchiolitis_diagnoses$adj_abstract_based_charges <- cost_cleaning_function(primary_bronchiolitis_diagnoses$adj_abstract_based_charges, "primary_bronchiolitis_diagnoses$adj_abstract_based_charges")


# Apply cost cleaning to APR-DRG bronchiolitis table
apr_drg_bronchiolitis$estimated_cost <- cost_cleaning_function(apr_drg_bronchiolitis$estimated_cost, "apr_drg_bronchiolitis$estimated_cost")

apr_drg_bronchiolitis$adj_estimated_cost <- cost_cleaning_function(apr_drg_bronchiolitis$adj_estimated_cost, "apr_drg_bronchiolitis$adj_estimated_cost")

apr_drg_bronchiolitis$abstract_based_charges <- cost_cleaning_function(apr_drg_bronchiolitis$abstract_based_charges, "apr_drg_bronchiolitis$abstract_based_charges")

apr_drg_bronchiolitis$adj_abstract_based_charges <- cost_cleaning_function(apr_drg_bronchiolitis$adj_abstract_based_charges, "apr_drg_bronchiolitis$adj_abstract_based_charges")

rm(cost_cleaning_function)
```

```{r load files with invasive and noninvasive ventilation codes, generate columns for invasive and noninvasive ventilation}

# The codes used to define invasive and noninvasive mechanical ventilation here are from supplemental table 5 of Fujiogi M, Goto T, Yasunaga H, et al. Trends in Bronchiolitis Hospitalizations in the United States: 2000-2016. Pediatrics. 2019.

# There is one important exception to the above: ICD-9-CM code 93.01 (PT evaluation) in the above reference was substituted for 96.01 (insert NP airway) below - I assumed that the citation had a typo in using a PT evaluation code as diagnostic for mechanical ventilation.

reading_ventilation_codes_function <- function(invasive_ventilation_csv_file, non_invasive_ventilation_csv_file, bronchiolits_table, bronchiolits_table_name) {
  invasive_ventilation <- read_csv(invasive_ventilation_csv_file,
    col_types =
      cols(
        `Hospital Number` = col_double(),
        `Hospital City` = col_factor(),
        `Medical Record Number` = col_double(),
        `Discharge ID` = col_double(),
        `Billing Number` = col_character(),
        `Px Version` = col_double(),
        `Px Code - Title (ICD)` = col_factor()
      )
  )
  noninvasive_ventilation <- read_csv(non_invasive_ventilation_csv_file,
    col_types =
      cols(
        `Hospital Number` = col_double(),
        `Hospital City` = col_factor(),
        `Medical Record Number` = col_double(),
        `Discharge ID` = col_double(),
        `Billing Number` = col_character(),
        `Px Version` = col_double(),
        `Px Code - Title (ICD)` = col_factor()
      )
  )
  invasive_ventilation$invasive_vent_flag <- "Y"
  invasive_ventilation <- invasive_ventilation %>%
    select("discharge_id" = `Discharge ID`, invasive_vent_flag)
  invasive_ventilation <- invasive_ventilation[!duplicated(invasive_ventilation$discharge_id), ]
  noninvasive_ventilation$noninvasive_vent_flag <- "Y"
  noninvasive_ventilation <- noninvasive_ventilation %>%
    select("discharge_id" = `Discharge ID`, noninvasive_vent_flag)
  noninvasive_ventilation <- noninvasive_ventilation[!duplicated(noninvasive_ventilation$discharge_id), ]
  temp_table <- left_join(bronchiolits_table, noninvasive_ventilation, by = "discharge_id")
  temp_table <- left_join(temp_table, invasive_ventilation, by = "discharge_id")
  temp_table$invasive_vent_flag <- replace_na(temp_table$invasive_vent_flag, "N")
  temp_table$invasive_vent_flag <- as.factor(temp_table$invasive_vent_flag)
  temp_table$noninvasive_vent_flag <- replace_na(temp_table$noninvasive_vent_flag, "N")
  temp_table$noninvasive_vent_flag <- as.factor(temp_table$noninvasive_vent_flag)
  temp_table <- temp_table %>% mutate(invasive_and_noninvasive_vent_flag = if_else(noninvasive_vent_flag == "Y" & invasive_vent_flag == "Y", "Y", "N"))
  temp_table$invasive_and_noninvasive_vent_flag <- as.factor(temp_table$invasive_and_noninvasive_vent_flag)
  temp_table <- temp_table %>% mutate(highest_vent_support = case_when(
    invasive_vent_flag == "Y" ~ "invasive",
    noninvasive_vent_flag == "Y" & invasive_vent_flag == "N" ~ "noninvasive",
    noninvasive_vent_flag == "N" & invasive_vent_flag == "N" ~ "none"
  ))
  temp_table$highest_vent_support <- factor(temp_table$highest_vent_support, levels = c("none", "noninvasive", "invasive"))
  cat("The following information applies to:", bronchiolits_table_name, "\n")
  cat("There are", nrow(temp_table), "admissions.\n")
  cat("There are", nrow(subset(temp_table, invasive_vent_flag == "Y")), "admissions with invasive ventilation.\n")
  cat("There are", nrow(subset(temp_table, noninvasive_vent_flag == "Y")), "admissions with noninvasive ventilation.\n")
  cat("There are", nrow(subset(temp_table, invasive_and_noninvasive_vent_flag == "Y")), "admissions with both invasive and noninvasive ventilation.\n")
  cat("There are", nrow(subset(temp_table, highest_vent_support == "invasive")), "admissions with invasive ventilation as the highest level of support (should match the number with invasive ventilation).\n")
  cat("There are", nrow(subset(temp_table, highest_vent_support == "noninvasive")), "admissions with noninvasive ventilation as the highest level of support (should be the number with noninvasive ventilation minus the number with both invasive and noninvasive).\n")
  cat("There are", nrow(subset(temp_table, highest_vent_support == "none")), "admissions with no ventilatory support.\n\n\n")
  return(temp_table)
}

all_bronchiolitis_diagnoses <- reading_ventilation_codes_function("Bronchiolitis_PHIS_Reports/All_Bronchiolitis_Invasive_Ventilation_Codes.csv", "Bronchiolitis_PHIS_Reports/All_Bronchiolitis_Noninvasive_Ventilation_Codes.csv", all_bronchiolitis_diagnoses, "All Bronchiolitis Diagnoses Table")

primary_bronchiolitis_diagnoses <- reading_ventilation_codes_function("Bronchiolitis_PHIS_Reports/Bronchiolitis_Primary_Diagnosis_Invasive_Ventilation_Codes.csv", "Bronchiolitis_PHIS_Reports/Bronchiolitis_Primary_Diagnosis_Noninvasive_Ventilation_Codes.csv", primary_bronchiolitis_diagnoses, "Primary Bronchiolitis Diagnoses Table")

apr_drg_bronchiolitis <- reading_ventilation_codes_function("Bronchiolitis_PHIS_Reports/Bronchiolitis_APR-DRG_v32_Invasive_Ventilation_Codes.csv", "Bronchiolitis_PHIS_Reports/Bronchiolitis_APR-DRG_v32_Noninvasive_Ventilation_Codes.csv", apr_drg_bronchiolitis, "APR-DRG v32 Bronchiolitis Diagnoses Table")

rm(reading_ventilation_codes_function)
```

```{r generate a total vent support factor column}
total_vent_function <- function(bronchiolitis_table) {
  bronchiolitis_table <- bronchiolitis_table %>% mutate(total_vent_support = case_when(
    invasive_vent_flag == "Y" & noninvasive_vent_flag == "Y" ~ "both",
    invasive_vent_flag == "Y" & noninvasive_vent_flag == "N" ~ "invasive",
    noninvasive_vent_flag == "Y" & invasive_vent_flag == "N" ~ "noninvasive",
    noninvasive_vent_flag == "N" & invasive_vent_flag == "N" ~ "none"
  ))
  bronchiolitis_table$total_vent_support <- as.factor(bronchiolitis_table$total_vent_support)
  return(bronchiolitis_table)
}

all_bronchiolitis_diagnoses <- total_vent_function(all_bronchiolitis_diagnoses)
primary_bronchiolitis_diagnoses <- total_vent_function(primary_bronchiolitis_diagnoses)
apr_drg_bronchiolitis <- total_vent_function(apr_drg_bronchiolitis)

rm(total_vent_function)
```

```{r generate an invasive vent numeric column}
vent_numeric_function <- function(bronchiolitis_table) {
  bronchiolitis_table <- bronchiolitis_table %>%
    mutate(invasive_vent_numeric = case_when(
      invasive_vent_flag == "Y" ~ 1,
      invasive_vent_flag == "N" ~ 0
    ))

  bronchiolitis_table <- bronchiolitis_table %>%
    mutate(noninvasive_vent_numeric = case_when(
      noninvasive_vent_flag == "Y" ~ 1,
      noninvasive_vent_flag == "N" ~ 0
    ))

  return(bronchiolitis_table)
}

all_bronchiolitis_diagnoses <- vent_numeric_function(all_bronchiolitis_diagnoses)
primary_bronchiolitis_diagnoses <- vent_numeric_function(primary_bronchiolitis_diagnoses)
apr_drg_bronchiolitis <- vent_numeric_function(apr_drg_bronchiolitis)
rm(vent_numeric_function)
```

```{r restrict cohorts to hospitals with 10 years of data}

years_of_data_function <- function(bronchiolitis_table) {
  years_of_data <- bronchiolitis_table %>%
    group_by(hospital_number) %>%
    dplyr::summarise(
      "years" = max(discharge_year) - min(discharge_year)
    )
  years_of_data <- subset(years_of_data, years_of_data$years == 9) # this is 9 and not 10 because 2019-2010 = 9
  temp <- subset(bronchiolitis_table, hospital_number %in% years_of_data$hospital_number) # select for hospitals with 10 years of data (max-min=9)
  return(temp)
}

all_bronchiolitis_diagnoses <- years_of_data_function(all_bronchiolitis_diagnoses)
primary_bronchiolitis_diagnoses <- years_of_data_function(primary_bronchiolitis_diagnoses)
apr_drg_bronchiolitis <- years_of_data_function(apr_drg_bronchiolitis)

rm(years_of_data_function)
```

```{r confirm that there are no duplicate discharge_id values}

ifelse(nrow(subset(all_bronchiolitis_diagnoses, duplicated(all_bronchiolitis_diagnoses$discharge_id))) == 0, paste("GOOD TO GO: There are no duplicated discharge IDs within the all bronchiolitis spreadsheet."), paste("WARNING: There are duplicate discharge IDs within the all bronchiolitis spreadsheet."))

ifelse(nrow(subset(primary_bronchiolitis_diagnoses, duplicated(primary_bronchiolitis_diagnoses$discharge_id))) == 0, paste("GOOD TO GO: There are no duplicated discharge IDs within the primary bronchiolitis diagnosis spreadsheet."), paste("WARNING: There are duplicate discharge IDs within the primary bronchiolitis diagnosis spreadsheet."))

ifelse(nrow(subset(apr_drg_bronchiolitis, duplicated(apr_drg_bronchiolitis$discharge_id))) == 0, paste("GOOD TO GO: There are no duplicated discharge IDs within the APR-DRG v32 bronchiolitis spreadsheet."), paste("WARNING: There are duplicate discharge IDs within the APR-DRG v32 bronchiolitis spreadsheet."))

```

```{r develop cohorts with and without ccc}
all_bronchiolitis_diagnoses_no_ccc <- subset(all_bronchiolitis_diagnoses, complex_chronic_condition_flag == "N")
all_bronchiolitis_diagnoses_yes_ccc <- subset(all_bronchiolitis_diagnoses, complex_chronic_condition_flag == "Y")

primary_bronchiolitis_diagnoses_no_ccc <- subset(primary_bronchiolitis_diagnoses, complex_chronic_condition_flag == "N")
primary_bronchiolitis_diagnoses_yes_ccc <- subset(primary_bronchiolitis_diagnoses, complex_chronic_condition_flag == "Y")
```

```{r develop_pittsburgh_primary_cohort}
pittsburgh_primary_bronchiolitis_diagnoses <- filter(primary_bronchiolitis_diagnoses, hospital_city == "Pittsburgh")
```

```{r generate table 1 or demographics table}

# complex chronic condition flag definitions can be found at: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4134331/ associated ICD codes can be found in additional file 5

# note that the mechanical ventilation flag being used here is that from PHIS, which is DIFFERENT from that used by Fujiogi M, Goto T, Yasunaga H, et al. Trends in Bronchiolitis Hospitalizations in the United States: 2000-2016. Pediatrics. 2019.

demographics_table_function <- function(cohort_table, cohort_name, cohort_discharge_id_column) {
  demographics_table <- cohort_table %>% summarise(
    "number of unique admissions" = n_distinct(discharge_id),
    "number of unique patients" = n_distinct(medical_record_number),
    "median age in months (IQR)" = median(admit_age_in_months),
    "25% age in months" = quantile(admit_age_in_months, probs = c(0.25)),
    "75% age in months" = quantile(admit_age_in_months, probs = c(0.75)),
    "male" = sum(gender_title == "Male"),
    "white" = sum(race_white == "Y"),
    "black" = sum(race_black == "Y"),
    "asian" = sum(race_asian == "Y"),
    "american indian" = sum(race_american_indian == "Y"),
    "pacific islander" = sum(race_pacific_islander == "Y"),
    "other race" = sum(race_other == "Y"),
    "hispanic" = sum(ethnicity_title == "Hispanic or Latino"),
    "commercial insurance" = sum(primary_source_of_payment_simplified == "Commercial"),
    "government insurance" = sum(primary_source_of_payment_simplified == "Government"),
    "other insurance" = sum(primary_source_of_payment_simplified == "Other"),
    "complex chronic condition" = sum(complex_chronic_condition_flag == "Y"),
    "cardiovascular condition" = sum(cardiovascular_flag == "Y"),
    "gastrointestinal condition" = sum(gastrointestinal_flag == "Y"),
    "hematologic or immunologic condition" = sum(hematologic_or_immunologic_flag == "Y"),
    "malignancy" = sum(malignancy_flag == "Y"),
    "metabolic condition" = sum(metabolic_flag == "Y"),
    "neurologic condition" = sum(neurologic_and_neuromuscular_flag == "Y"),
    "genetic condition" = sum(other_congenital_or_genetic_defect_flag == "Y"),
    "premature or neonatal condition" = sum(premature_and_neonatal_flag == "Y"),
    "renal condition" = sum(renal_and_urologic_flag == "Y"),
    "respiratory condition" = sum(respiratory_flag == "Y"),
    "technology dependent" = sum(technology_dependent_flag == "Y"),
    "transplant recipient" = sum(transplant_flag == "Y"),
    "mental health disorder" = sum(mental_health_disorder_flag == "Y"),
    "secondary mental health disorder" = sum(secondary_dx_mental_health_disorder_flag == "Y"),
    "median hospital length of stay (IQR)" = median(length_of_stay),
    "25% hospital length of stay" = quantile(length_of_stay, probs = c(0.25)),
    "75% hospital length of stay" = quantile(length_of_stay, probs = c(0.75)),
    "admitted to icu" = sum(icu_flag == "Y"),
    "highest support of invasive ventilation" = sum(highest_vent_support == "invasive"),
    "highest support of noninvasive ventilation" = sum(highest_vent_support == "noninvasive"),
    "no ventilatory support" = sum(highest_vent_support == "none"),
    "received ecmo" = sum(ecmo_flag == "Y"),
    "median cost (IQR)" = median(estimated_cost, na.rm = TRUE),
    "25% cost" = quantile(estimated_cost, probs = c(0.25), na.rm = TRUE),
    "75% cost" = quantile(estimated_cost, probs = c(0.75), na.rm = TRUE),
    "median abstracted charge (IQR)" = median(abstract_based_charges, na.rm = TRUE),
    "25% abstracted charge" = quantile(abstract_based_charges, probs = c(0.25), na.rm = TRUE),
    "75% abstracted charge" = quantile(abstract_based_charges, probs = c(0.75), na.rm = TRUE),
    "median cms adjusted cost (IQR)" = median(adj_estimated_cost, na.rm = TRUE),
    "25% cms adjusted cost" = quantile(adj_estimated_cost, probs = c(0.25), na.rm = TRUE),
    "75% cms adjusted cost" = quantile(adj_estimated_cost, probs = c(0.75), na.rm = TRUE),
    "median cms adjusted abstracted charge (IQR)" = median(adj_abstract_based_charges, na.rm = TRUE),
    "25% cms adjusted abstracted charge" = quantile(adj_abstract_based_charges, probs = c(0.25), na.rm = TRUE),
    "75% cms adjusted abstracted charge" = quantile(adj_abstract_based_charges, probs = c(0.75), na.rm = TRUE),
    "survived to discharge" = sum(discharge_mortality_flag == "N")
  )
  demographics_table <- as_tibble(cbind(variable = names(demographics_table), t(demographics_table)), .name_repair = c("minimal"))
  colnames(demographics_table) <- c("Variable", "cohort_n")
  demographics_table$Variable <- as.character(demographics_table$Variable)
  demographics_table$cohort_n <- as.numeric(demographics_table$cohort_n)
  demographics_table$cohort_percent <- round((demographics_table$cohort_n / n_distinct(cohort_discharge_id_column) * 100), digits = 2)
  demographics_table <- rbind(c("Variable", cohort_name, ""), demographics_table) # add headers for hux
  demographics_table$cohort_percent <- gsub("$", "\\%", demographics_table$cohort_percent) # add percents to end of col3
  demographics_table[4, 3] <- paste(demographics_table[[5, 2]], demographics_table[[6, 2]], sep = "-") # add IQR for ages
  demographics_table <- demographics_table[-c(5, 6), ] # remove 25% and 75% rows
  demographics_table[31, 3] <- paste(demographics_table[[32, 2]], demographics_table[[33, 2]], sep = "-") # add IQR for LOS
  demographics_table <- demographics_table[-c(32, 33), ] # remove 25% and 75% rows
  demographics_table[37, 3] <- paste(demographics_table[[38, 2]], demographics_table[[39, 2]], sep = "-") # add IQR for cost
  demographics_table <- demographics_table[-c(38, 39), ] # remove 25% and 75% rows
  demographics_table[38, 3] <- paste(demographics_table[[39, 2]], demographics_table[[40, 2]], sep = "-") # add IQR adj cost
  demographics_table <- demographics_table[-c(39, 40), ] # remove 25% and 75% rows
  demographics_table[39, 3] <- paste(demographics_table[[40, 2]], demographics_table[[41, 2]], sep = "-") # add IQR charge
  demographics_table <- demographics_table[-c(40, 41), ] # remove 25% and 75% rows
  demographics_table[40, 3] <- paste(demographics_table[[41, 2]], demographics_table[[42, 2]], sep = "-") # add IQR adj chrg
  demographics_table <- demographics_table[-c(41, 42), ] # remove 25% and 75% rows
  demographics_table <- demographics_table[-c(29, 30), ] # remove mental health disorders (clinically meaningless)
  demographics_table$cohort_percent <- gsub("^", "\\(", demographics_table$cohort_percent) # add parenthesis to beginng of col3
  demographics_table$cohort_percent <- gsub("$", "\\)", demographics_table$cohort_percent) # add parenthesis to end of col3
  demographics_table[3, 3] <- "" # remove percents from unique patients
  demographics_table[1, 3] <- "" # remove header for third column
  demographics_table <- unite(demographics_table, Values, c(cohort_n, cohort_percent), sep = " ")
  demographics_table$Values <- gsub(" $", "", demographics_table$Values) # remove terminal spaces from merging
  return(demographics_table)
}

demographics_all_bronchiolitis <- demographics_table_function(all_bronchiolitis_diagnoses, "All Bronchiolitis Diagnoses", all_bronchiolitis_diagnoses$discharge_id)

demographics_all_bronchiolitis_no_ccc <- demographics_table_function(all_bronchiolitis_diagnoses_no_ccc, "All Bronchiolitis Diagnoses Without CCC", all_bronchiolitis_diagnoses_no_ccc$discharge_id)

demographics_all_bronchiolitis_yes_ccc <- demographics_table_function(all_bronchiolitis_diagnoses_yes_ccc, "All Bronchiolitis Diagnoses With CCC", all_bronchiolitis_diagnoses_yes_ccc$discharge_id)

demographics_primary_bronchiolitis_diagnoses <- demographics_table_function(primary_bronchiolitis_diagnoses, "Bronchiolitis Primary Diagnoses", primary_bronchiolitis_diagnoses$discharge_id)

demographics_primary_bronchiolitis_diagnoses_no_ccc <- demographics_table_function(primary_bronchiolitis_diagnoses_no_ccc, "Bronchiolitis Primary Diagnoses Without CCC", primary_bronchiolitis_diagnoses_no_ccc$discharge_id)

demographics_primary_bronchiolitis_diagnoses_yes_ccc <- demographics_table_function(primary_bronchiolitis_diagnoses_yes_ccc, "Bronchiolitis Primary Diagnoses With CCC", primary_bronchiolitis_diagnoses_yes_ccc$discharge_id)

demographics_apr_drg_bronchiolitis <- demographics_table_function(apr_drg_bronchiolitis, "APR-DRG v32 Bronchiolitis", apr_drg_bronchiolitis$discharge_id)

rm(demographics_table_function)

demographics_combined <- left_join(demographics_all_bronchiolitis, demographics_all_bronchiolitis_no_ccc, by = "Variable")
demographics_combined <- left_join(demographics_combined, demographics_all_bronchiolitis_yes_ccc, by = "Variable")
demographics_combined <- left_join(demographics_combined, demographics_primary_bronchiolitis_diagnoses, by = "Variable")
demographics_combined <- left_join(demographics_combined, demographics_primary_bronchiolitis_diagnoses_no_ccc, by = "Variable")
demographics_combined <- left_join(demographics_combined, demographics_primary_bronchiolitis_diagnoses_yes_ccc, by = "Variable")
demographics_combined <- left_join(demographics_combined, demographics_apr_drg_bronchiolitis, by = "Variable")

rm(demographics_all_bronchiolitis, demographics_primary_bronchiolitis_diagnoses, demographics_apr_drg_bronchiolitis, demographics_all_bronchiolitis_no_ccc, demographics_all_bronchiolitis_yes_ccc, demographics_primary_bronchiolitis_diagnoses_no_ccc, demographics_primary_bronchiolitis_diagnoses_yes_ccc)
```

# Demographics

## Commentary {.sidebar}

Here are the demographics for patients entered into PHIS with diagnostic codes of viral bronchiolitis.

Moving left to right, the cohorts become progressively more restrictive.

Patients in the "All Bronchiolitis Diagnoses" cohort have ICD9/ICD10 codes for viral bronchiolitis as any diagnosis associated with that admission. Patients in the "Primary Bronchiolitis Diagnoses" cohort have a primary admission diagnosis of viral bronchiolitis. These cohorts are then further subdivided into patients with and without complex chronic conditions (CCC). The last column is the All Patient Refined Diagnosis Group, version 32 (APR-DRG v32) for viral bronchiolitis. These patients are selected by a proprietary algorithm developed by 3M.

## Demographics Table

```{r generate demographics huxtable, results="hold"}
# Generate Huxtable
library(huxtable)
ht <- hux(demographics_combined)
caption(ht) <- "Table 1: Cohort Demographics"
right_padding(ht) <- 10 # line up numbers
left_padding(ht) <- 10 # line up numbers
ht <- theme_plain(ht)
detach("package:huxtable", unload = TRUE)
rm(ht)

# Show demographics table without the spurious row needed for huxtable formatting

library(kableExtra)
colnames(demographics_combined) <- demographics_combined[1, ]

knitr::kable(demographics_combined[-1, ]) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), fixed_thead = F) %>%
  pack_rows("n", 1, 2) %>%
  pack_rows("Age", 3, 3) %>%
  pack_rows("Sex", 4, 4) %>%
  pack_rows("Race", 5, 10) %>%
  pack_rows("Ethnicity", 11, 11) %>%
  pack_rows("Insurance", 12, 14) %>%
  pack_rows("Complex Chronic Conditions", 15, 27) %>%
  pack_rows("Admission Characteristics", 28, 33) %>%
  pack_rows("Cost of Care", 34, 37) %>%
  pack_rows("Survival", 38, 38)
```

# Incidence

```{r load_all_hospital_admissions_file}
# import data file with all PHIS hospital admissions, ICU admissions, and ECMO cases for 2010-2019
all_hospital_admissions <- read_csv("Bronchiolitis_PHIS_Reports//All_Hospital_Admissions_and_ICU_Admissions_Under_2.csv", col_types = cols(
  `Hospital Number` = col_double(),
  `Hospital City` = col_factor(),
  `Discharge Year` = col_double(),
  `Number Of Patients` = col_number(),
  `Number Of Cases` = col_number(),
  `ICU Count` = col_number(),
  `Mechanical Vent Count` = col_number(),
  `ECMO Count` = col_double()
))

names(all_hospital_admissions) <- names(all_hospital_admissions) %>%
  stringr::str_replace_all("\\s", "_") %>%
  tolower()

# restrict to admissions from hospitals in the main analysis

all_hospital_admissions <- all_bronchiolitis_diagnoses %>%
  select(hospital_city) %>%
  distinct(hospital_city) %>%
  left_join(., all_hospital_admissions, by = "hospital_city")

# generate pittsburgh all hospital admissions table
pittburgh_all_hospital_admissions <- all_hospital_admissions %>%
  filter(hospital_city == "Pittsburgh")
```


```{r overall incidence of bronchiolitis in PHIS by year}
library(lubridate)

# Generate summary of yearly bronchiolitis admissions

yearly_graph_function <- function(bronchiolitis_table, admission_graph_name, patients_graph_name, icu_admission_graph_name, ecmo_graph_name) {
  yearly_bronchiolitis_admissions <- bronchiolitis_table %>%
    group_by(discharge_year) %>%
    summarise(
      "admissions" = n_distinct(discharge_id),
      "patients" = n_distinct(medical_record_number),
      "icu_admissions" = sum(icu_flag == "Y"),
      "ecmo_admissions" = sum(ecmo_flag == "Y"),
      "admit_type" = "bronchiolitis"
    )

  hospital_vs_bronchiolitis_admissions <- all_hospital_admissions %>%
    group_by(discharge_year) %>%
    summarize(
      "admissions" = sum(number_of_cases),
      "patients" = sum(number_of_patients),
      "icu_admissions" = sum(icu_count),
      "ecmo_admissions" = sum(ecmo_count),
      "admit_type" = "all_hospital"
    )

  hospital_vs_bronchiolitis_admissions <- rbind(hospital_vs_bronchiolitis_admissions, yearly_bronchiolitis_admissions)

  hospital_vs_bronchiolitis_proportions <- hospital_vs_bronchiolitis_admissions %>% pivot_wider(id_cols = discharge_year, names_from = admit_type, values_from = c(admissions, patients, icu_admissions, ecmo_admissions))

  hospital_vs_bronchiolitis_proportions <- hospital_vs_bronchiolitis_proportions %>%
    mutate(admissions_proportion = admissions_bronchiolitis / admissions_all_hospital) %>%
    mutate(patients_proportion = patients_bronchiolitis / patients_all_hospital) %>%
    mutate(icu_admissions_proportion = icu_admissions_bronchiolitis / icu_admissions_all_hospital) %>%
    mutate(ecmo_admissions_proportion = ecmo_admissions_bronchiolitis / ecmo_admissions_all_hospital)

  admission_graph <- ggplot(data = hospital_vs_bronchiolitis_admissions, mapping = aes(x = discharge_year)) +
    geom_bar(stat = "identity", position = "dodge", mapping = aes(y = admissions, fill = admit_type)) +
    geom_line(data = hospital_vs_bronchiolitis_proportions, aes(y = admissions_proportion * 1000000)) +
    scale_y_continuous(sec.axis = sec_axis(~ . / 1000000 * 100, name = "% Bronchiolitis")) +
    ylab("n") +
    scale_x_continuous(name = "Discharge Year", breaks = c(2010:2019)) +
    scale_fill_manual(values = c("gray60", "gray80"), name = "Type of Admission", labels = c("All Hospital Admissions", "Bronchiolitis Admissions")) +
    theme_bw() +
    theme(legend.position = "none") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    labs(title = admission_graph_name)

  patients_graph <- ggplot(data = hospital_vs_bronchiolitis_admissions, mapping = aes(x = discharge_year)) +
    geom_bar(stat = "identity", position = "dodge", mapping = aes(y = patients, fill = admit_type)) +
    geom_line(data = hospital_vs_bronchiolitis_proportions, aes(y = patients_proportion * 1000000)) +
    scale_y_continuous(sec.axis = sec_axis(~ . / 1000000 * 100, name = "% Bronchiolitis")) +
    ylab("n") +
    scale_x_continuous(name = "Discharge Year", breaks = c(2010:2019)) +
    scale_fill_manual(values = c("gray60", "gray80"), name = "Type of Patient", labels = c("All Hospital Patients", "Bronchiolitis Patients")) +
    theme_bw() +
    theme(legend.position = "none") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    labs(title = patients_graph_name)

  icu_admission_graph <- ggplot(data = hospital_vs_bronchiolitis_admissions, mapping = aes(x = discharge_year)) +
    geom_bar(stat = "identity", position = "dodge", mapping = aes(y = icu_admissions, fill = admit_type)) +
    geom_line(data = hospital_vs_bronchiolitis_proportions, aes(y = icu_admissions_proportion * 100000)) +
    scale_y_continuous(sec.axis = sec_axis(~ . / 100000 * 100, name = "% Bronchiolitis")) +
    ylab("n") +
    scale_x_continuous(name = "Discharge Year", breaks = c(2010:2019)) +
    scale_fill_manual(values = c("gray60", "gray80"), name = "Type of ICU Admission", labels = c("All Hospital ICU Admissions", "Bronchiolitis ICU Admissions")) +
    theme_bw() +
    theme(legend.position = "none") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    labs(title = icu_admission_graph_name)

  ecmo_admission_graph <- ggplot(data = hospital_vs_bronchiolitis_admissions, mapping = aes(x = discharge_year)) +
    geom_bar(stat = "identity", position = "dodge", mapping = aes(y = ecmo_admissions, fill = admit_type)) +
    geom_line(data = hospital_vs_bronchiolitis_proportions, aes(y = ecmo_admissions_proportion * 5000)) +
    scale_y_continuous(sec.axis = sec_axis(~ . / 5000 * 100, name = "% Bronchiolitis")) +
    ylab("n") +
    scale_x_continuous(name = "Discharge Year", breaks = c(2010:2019)) +
    scale_fill_manual(values = c("gray60", "gray80"), name = "Type of ECMO Admission", labels = c("All Hospital ECMO Admissions", "Bronchiolitis ECMO Admissions")) +
    theme_bw() +
    theme(legend.position = "none") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    theme(plot.title = element_text(hjust = 0.5)) +
    labs(title = ecmo_graph_name)

  return(list(admission_graph, patients_graph, icu_admission_graph, ecmo_admission_graph))
}

all_bronchiolitis_yearly_graphs <- yearly_graph_function(
  bronchiolitis_table = all_bronchiolitis_diagnoses,
  admission_graph_name = "All Bronchiolitis Diagnoses",
  patients_graph_name = "All Bronchiolitis Diagnoses",
  icu_admission_graph_name = "All Bronchiolitis Diagnoses",
  ecmo_graph_name = "All Bronchiolitis Diagnoses"
)

primary_bronchiolitis_yearly_graphs <- yearly_graph_function(
  bronchiolitis_table = primary_bronchiolitis_diagnoses,
  admission_graph_name = "Primary Bronchiolitis Diagnoses",
  patients_graph_name = "Primary Bronchiolitis Diagnoses",
  icu_admission_graph_name = "Primary Bronchiolitis Diagnoses",
  ecmo_graph_name = "Primary Bronchiolitis Diagnoses"
)

apr_drg_bronchiolitis_yearly_graphs <- yearly_graph_function(
  bronchiolitis_table = apr_drg_bronchiolitis,
  admission_graph_name = "APR-DRG v32 Bronchiolitis",
  patients_graph_name = "APR-DRG v32 Bronchiolitis",
  icu_admission_graph_name = "APR-DRG v32 Bronchiolitis",
  ecmo_graph_name = "APR-DRG v32 Bronchiolitis"
)
```

## Commentary {.sidebar}

These graphs show the annual admission rate for the selected PHIS hospitals for all patients (dark gray) compared to bronchiolitis (light gray). The bars represent the absolute number of admissions, and the line (right axis) shows the trend in the percentage of admissions over time for bronchiolitis diagnoses.

These graphs show that the number of patients with bronchiolitis as and admission diagnosis is relatively constant over time, but that the number of patients with a primary diagnosis of bronchiolitis is decreasing over the past decade.

This is in contrast to the number of ICU admissions, where bronchiolitis represents a gradually increasing percentage of admissions across all cohorts.

The last series of graphs explains the rise in ICU admissions despite a falling overall admission count. The percentage of patients with bronchiolitis admitted to the ICU has significantly increased over time in all three cohorts.

## Trends Over Time {.tabset .tabset-fade}

### Annual Admissions
```{r, results = "hold", out.width="33%"}
all_bronchiolitis_yearly_graphs[[1]]
primary_bronchiolitis_yearly_graphs[[1]]
apr_drg_bronchiolitis_yearly_graphs[[1]]
```

### Annual Unique Patients
```{r, results = "hold", out.width="33%"}
all_bronchiolitis_yearly_graphs[[2]]
primary_bronchiolitis_yearly_graphs[[2]]
apr_drg_bronchiolitis_yearly_graphs[[2]]
```

### Annual ICU Admissions
```{r, results = "hold", out.width="33%"}
all_bronchiolitis_yearly_graphs[[3]]
primary_bronchiolitis_yearly_graphs[[3]]
apr_drg_bronchiolitis_yearly_graphs[[3]]
```

### Annual ECMO Admissions
```{r, results = "hold", out.width="33%"}
all_bronchiolitis_yearly_graphs[[4]]
primary_bronchiolitis_yearly_graphs[[4]]
apr_drg_bronchiolitis_yearly_graphs[[4]]
```

### Percentage Admitted To The ICU

```{r graph percent admitted to ICU by year, results = "hold", out.width="33%"}

yearly_graph_function <- function(bronchiolitis_table, graph_name) {
  yearly_bronchiolitis_mortality <- bronchiolitis_table %>%
    group_by(discharge_year) %>%
    summarise(
      "admissions" = n_distinct(discharge_id),
      "patients" = n_distinct(medical_record_number),
      "icu_admissions" = sum(icu_flag == "Y"),
      "number_dead" = sum(discharge_mortality_flag == "Y"),
      "proportion_icu" = sum(icu_flag == "Y") / n_distinct(discharge_id)
    )

  linear_icu_over_time <- lm(proportion_icu ~ discharge_year, data = yearly_bronchiolitis_mortality)
  temp_delta <- round(summary(linear_icu_over_time)$coefficients[2, 1] * 100, 3)

  yearly_plot <- ggplot(data = yearly_bronchiolitis_mortality, mapping = aes(x = discharge_year, y = proportion_icu * 100)) +
    geom_bar(stat = "identity", fill = "gray80") +
    geom_text(aes(label = round(proportion_icu * 100, digits = 2)), color = "black", position = position_stack(vjust = 0.5), size = 3) +
    ylab("% of Bronchiolitis Admissions Admitted to ICU") +
    scale_x_continuous(name = "Discharge Year", breaks = c(2010:2019)) +
    theme_bw() +
    labs(title = graph_name, subtitle = paste("ICU admission is changing by ", temp_delta, "% per year. \nLinear regression r^2: ", round(summary(linear_icu_over_time)$r.squared, digits = 3), ". P-value: ", ifelse(round(anova(linear_icu_over_time)[1, "Pr(>F)"], digits = 3) < 0.001, "<0.001", round(anova(linear_icu_over_time)[1, "Pr(>F)"], digits = 3)), ".", sep = "")) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5)) +
    theme(plot.caption = element_text(hjust = 0.5))

  return(yearly_plot)
}

yearly_graph_function(all_bronchiolitis_diagnoses, "All Bronchiolitis Diagnoses")

yearly_graph_function(primary_bronchiolitis_diagnoses, "Primary Bronchiolitis Diagnoses")

yearly_graph_function(apr_drg_bronchiolitis, "APR-DRG v32 Bronchiolitis")

pittsburgh_bronchiolitis_icu_yearly_graph <- yearly_graph_function(pittsburgh_primary_bronchiolitis_diagnoses, "Single-Center Primary Bronchiolitis Diagnoses")

rm(yearly_graph_function)

hospital_admission_icu_function <- function(hospital_admission_table, graph_name) {
  temp_table <- hospital_admission_table %>%
    ungroup() %>%
    group_by(discharge_year) %>%
    summarise(
      n_admissions = sum(number_of_cases),
      n_icu_admissions = sum(icu_count),
      proportion_icu = sum(icu_count) / sum(number_of_cases),
      .groups = "drop_last"
    )

  linear_icu_over_time <- lm(proportion_icu ~ discharge_year, data = temp_table)
  temp_delta <- round(summary(linear_icu_over_time)$coefficients[2, 1] * 100, 3)

  yearly_plot <- ggplot(data = temp_table, mapping = aes(x = discharge_year, y = proportion_icu * 100)) +
    geom_bar(stat = "identity", fill = "gray95", color = "black") +
    geom_text(aes(label = round(proportion_icu * 100, digits = 2)), color = "black", position = position_stack(vjust = 0.5), size = 3) +
    ylab("% of Hospital Admissions Admitted to ICU") +
    scale_x_continuous(name = "Discharge Year", breaks = c(2010:2019)) +
    theme_bw() +
    labs(title = graph_name, subtitle = paste("ICU admission is changing by ", temp_delta, "% per year. \nLinear regression r^2: ", round(summary(linear_icu_over_time)$r.squared, digits = 3), ". P-value: ", ifelse(round(anova(linear_icu_over_time)[1, "Pr(>F)"], digits = 3) < 0.001, "<0.001", round(anova(linear_icu_over_time)[1, "Pr(>F)"], digits = 3)), ".", sep = "")) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5)) +
    theme(plot.caption = element_text(hjust = 0.5))

  return(yearly_plot)
}

hospital_admission_icu_function(all_hospital_admissions, "All Hospital Admissions Under 2 Years of Age")

pittsburgh_all_admissions_icu_yearly_graph <- hospital_admission_icu_function(pittburgh_all_hospital_admissions, "Single-Center All Hospital Admissions Under 2 Years of Age")
```

# Ventilation

## Commentary {.sidebar}

These graphs show the proportion of patients receiving invasive (dark gray) and non-invasive (light gray) ventilation over time and across the PHIS hospitals.

The proportion of patients receiving non-invasive ventilation has increased greater than eight fold over the past decade, with the predominant increases over the past five years. This trend is statistically significant across all cohorts. The proportion of patients receiving invasive mechanical ventilation has not changed significantly. 

There is wide variability in hospital-level use of non-invasive ventilation. This is not correlated with rates of use of invasive ventilation.

## Ventilation Trends {.tabset .tabset-fade}

```{r rates of invasive and noninvasive ventilation by year and hospital}
library(lubridate)

yearly_graph_function <- function(bronchiolitis_table, graph_name) {
  yearly_bronchiolitis_ventilation <- bronchiolitis_table %>%
    group_by(discharge_year) %>%
    summarise(
      "admissions" = n_distinct(discharge_id),
      "patients" = n_distinct(medical_record_number),
      "icu_admissions" = sum(icu_flag == "Y"),
      "number_no_vent_support" = sum(highest_vent_support == "none"),
      "number_noninvasive_vent_support" = sum(highest_vent_support == "noninvasive"),
      "number_invasive_vent_support" = sum(highest_vent_support == "invasive"),
      "proportion_no_vent_support" = sum(highest_vent_support == "none") / n_distinct(discharge_id),
      "proportion_noninvasive_vent_support" = sum(highest_vent_support == "noninvasive") / n_distinct(discharge_id),
      "proportion_invasive_vent_support" = sum(highest_vent_support == "invasive") / n_distinct(discharge_id),
      "number_ecmo_admissions" = sum(ecmo_flag == "Y"),
      "proportion_ecmo_admissions" = sum(ecmo_flag == "Y") / n_distinct(discharge_id)
    )

  linear_invasive_vent_over_time <- lm(proportion_invasive_vent_support ~ discharge_year, data = yearly_bronchiolitis_ventilation)

  linear_noninvasive_vent_over_time <- lm(proportion_noninvasive_vent_support ~ discharge_year, data = yearly_bronchiolitis_ventilation)

  pivot_table <- yearly_bronchiolitis_ventilation %>% pivot_longer(cols = c(proportion_noninvasive_vent_support, proportion_invasive_vent_support))
  pivot_table$name <- factor(pivot_table$name, levels = c("proportion_noninvasive_vent_support", "proportion_invasive_vent_support"))

  yearly_plot <- ggplot(data = pivot_table, mapping = aes(x = discharge_year, y = value * 100, fill = name)) +
    geom_bar(position = "stack", stat = "identity") +
    geom_text(aes(label = round(value * 100, digits = 2)), color = "black", position = position_stack(vjust = 0.5), size = 3) +
    ylab("% of Admissions Receiving Ventilatory Support") +
    scale_x_continuous(name = "Discharge Year", breaks = c(2010:2019)) +
    theme_bw() +
    labs(title = graph_name, caption = "Note: patients who received both types of ventilation were classified as invasive.", subtitle = paste("Invasive linear regression r^2: ", round(summary(linear_invasive_vent_over_time)$r.squared, digits = 3), ". P-value: ", round(anova(linear_invasive_vent_over_time)[1, "Pr(>F)"], digits = 3), ".\n", "Noninvasive linear regression r^2: ", round(summary(linear_noninvasive_vent_over_time)$r.squared, digits = 3), ". P-value: ", ifelse(round(anova(linear_noninvasive_vent_over_time)[1, "Pr(>F)"], digits = 3) < 0.001, "<0.001", round(anova(linear_noninvasive_vent_over_time)[1, "Pr(>F)"], digits = 3)), ".", sep = "")) +
    scale_fill_manual(values = c("gray90", "gray80"), name = "Type of Ventilator Support", labels = c("Noninvasive", "Invasive")) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5)) +
    theme(plot.caption = element_text(hjust = 0.5)) +
    theme(legend.position = "none")

  return(yearly_plot)
}

year_all <- yearly_graph_function(all_bronchiolitis_diagnoses, "All Bronchiolitis Diagnoses")

year_primary <- yearly_graph_function(primary_bronchiolitis_diagnoses, "Primary Bronchiolitis Diagnoses")

year_apr_drg <- yearly_graph_function(apr_drg_bronchiolitis, "APR-DRG v32 Bronchiolitis")

rm(yearly_graph_function)

hospital_graph_function <- function(bronchiolitis_table, graph_name) {
  hospital_bronchiolitis_admissions <- bronchiolitis_table %>%
    group_by(hospital_number) %>%
    summarise(
      "admissions" = n_distinct(discharge_id),
      "patients" = n_distinct(medical_record_number),
      "icu_admissions" = sum(icu_flag == "Y"),
      "number_no_vent_support" = sum(highest_vent_support == "none"),
      "number_noninvasive_vent_support" = sum(highest_vent_support == "noninvasive"),
      "number_invasive_vent_support" = sum(highest_vent_support == "invasive"),
      "proportion_no_vent_support" = sum(highest_vent_support == "none") / n_distinct(discharge_id),
      "proportion_noninvasive_vent_support" = sum(highest_vent_support == "noninvasive") / n_distinct(discharge_id),
      "proportion_invasive_vent_support" = sum(highest_vent_support == "invasive") / n_distinct(discharge_id),
      "ecmo_admissions" = sum(ecmo_flag == "Y"),
      "admit_type" = "bronchiolitis"
    )

  linear_noninvasive_vs_invasive <- lm(proportion_invasive_vent_support ~ proportion_noninvasive_vent_support, data = hospital_bronchiolitis_admissions)
  summary(linear_noninvasive_vs_invasive)

  hospital_plot <- hospital_bronchiolitis_admissions %>%
    mutate(noninvasive_vent_support_rank = rank(proportion_noninvasive_vent_support)) %>%
    pivot_longer(cols = c(proportion_noninvasive_vent_support, proportion_invasive_vent_support)) %>%
    ggplot(mapping = aes(x = noninvasive_vent_support_rank, y = value * 100, fill = name)) +
    geom_col(position = "dodge") +
    ylab("% of Admissions Receiving Ventilatory Support") +
    xlab("Hospital") +
    theme_bw() +
    labs(title = graph_name, caption = "Note: patients who received both types of ventilation were classified as invasive.", subtitle = paste("Noninvasive ventilation rate is not\ncorrelated with invasive ventilation rate.\nLinear regression r^2: ", round(summary(linear_noninvasive_vs_invasive)$r.squared, digits = 3), ". P-value: ", round(anova(linear_noninvasive_vs_invasive)[1, "Pr(>F)"], digits = 3), ".", sep = "")) +
    scale_fill_manual(values = c("gray60", "gray80"), name = "Type of Ventilator Support", labels = c("Invasive", "Noninvasive")) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5)) +
    theme(plot.caption = element_text(hjust = 0.5)) +
    theme(legend.position = "none")

  return(hospital_plot)
}

hospital_all <- hospital_graph_function(all_bronchiolitis_diagnoses, "All Bronchiolitis Diagnoses")

hospital_primary <- hospital_graph_function(primary_bronchiolitis_diagnoses, "Primary Bronchiolitis Diagnoses")

hospital_apr_drg <- hospital_graph_function(apr_drg_bronchiolitis, "APR-DRG v32 Bronchiolitis")

rm(hospital_graph_function)
```

### Invasive and Non-invasive Ventilation Over Time

```{r rates of invasive and noninvasive ventilation by year, results = "hold", out.width="33%"}
year_all
year_primary
year_apr_drg
rm(year_all, year_primary, year_apr_drg)
```

### Invasive and Non-invasive Ventilation By Hospital

```{r correlate hospital noninvasive and invasive ventilation rates, results = "hold", out.width="33%"}
hospital_all
hospital_primary
hospital_apr_drg
rm(hospital_all, hospital_primary, hospital_apr_drg)
```

### Invasive and Non-invasive Ventilation Among ICU Admissions

```{r ventilation_in_icu_admissions, results="hold", out.width="33%"}

icu_ventilation_function <- function(bronchiolitis_table, graph_name) {
  temp_table <- bronchiolitis_table %>%
    filter(icu_flag == "Y") %>%
    mutate(highest_none_numeric = ifelse(highest_vent_support == "none", 1, 0)) %>%
    mutate(highest_noninvasive_numeric = ifelse(highest_vent_support == "noninvasive", 1, 0)) %>%
    mutate(highest_invasive_numeric = ifelse(highest_vent_support == "invasive", 1, 0)) %>%
    group_by(discharge_year) %>%
    summarize(
      none = sum(highest_none_numeric),
      noninvasive = sum(highest_noninvasive_numeric),
      invasive = sum(highest_invasive_numeric),
      .groups = "drop_last"
    )

  temp_none_delta <- summary(lm(none ~ discharge_year, data = temp_table))$coefficients[2, 1]
  temp_none_p <- summary(lm(none ~ discharge_year, data = temp_table))$coefficients[2, 4]

  temp_noninvasive_delta <- summary(lm(noninvasive ~ discharge_year, data = temp_table))$coefficients[2, 1]
  temp_noninvasive_p <- summary(lm(noninvasive ~ discharge_year, data = temp_table))$coefficients[2, 4]

  temp_invasive_delta <- summary(lm(invasive ~ discharge_year, data = temp_table))$coefficients[2, 1]
  temp_invasive_p <- summary(lm(invasive ~ discharge_year, data = temp_table))$coefficients[2, 4]

  temp_table %>%
    pivot_longer(cols = c(none, noninvasive, invasive), values_to = "n", names_to = "highest_vent_support") %>%
    mutate(highest_vent_support = factor(highest_vent_support, levels = c("invasive", "noninvasive", "none"))) %>%
    ggplot(aes(x = factor(discharge_year), y = n, fill = highest_vent_support)) +
    geom_col(position = "stack") +
    scale_fill_grey(start = 0.6, end = 0.8) +
    geom_text(aes(label = n, x = factor(discharge_year), y = n, group = highest_vent_support), position = position_stack(vjust = 0.5), size = 3) +
    theme_bw() +
    labs(title = graph_name, subtitle = "Highest Level of Ventilatory Support Among Patients Admitted to the ICU", caption = paste("The number of patients admitted to the ICU for none is changing by ", round(temp_none_delta, 1), " per year, trend p", ifelse(temp_none_p < 0.001, "<0.001", paste("=", round(temp_none_p, 3), sep = "")), ".\n", "The number of patients admitted to the ICU for noninvasive is changing by ", round(temp_noninvasive_delta, 1), " per year, trend p", ifelse(temp_noninvasive_p < 0.001, "<0.001", paste("=", round(temp_noninvasive_p, 3), sep = "")), ".\n", "The number of patients admitted to the ICU for invasive is changing by ", round(temp_invasive_delta, 1), " per year, trend p", ifelse(temp_invasive_p < 0.001, "<0.001", paste("=", round(temp_invasive_p, 3), sep = "")), ".", sep = "")) +
    xlab("Discharge Year") +
    ylab("Number of Admissions") +
    theme(plot.subtitle = element_text(hjust = 0.5), plot.title = element_text(hjust = 0.5), legend.position = "none")
}

icu_ventilation_number_all <- icu_ventilation_function(all_bronchiolitis_diagnoses, "All Bronchiolitis Diagnoses")
icu_ventilation_number_primary <- icu_ventilation_function(primary_bronchiolitis_diagnoses, "Primary Bronchiolitis Diagnoses")
icu_ventilation_number_apr_drg <- icu_ventilation_function(apr_drg_bronchiolitis, "APR-DRG v32 Bronchiolitis Diagnoses")

icu_ventilation_number_pittsburgh <- icu_ventilation_function(pittsburgh_primary_bronchiolitis_diagnoses, "Single-Center Primary Bronchiolitis Diagnoses")

rm(icu_ventilation_function)

icu_proportion_ventilation_function <- function(bronchiolitis_table, graph_name) {
  temp_table <- bronchiolitis_table %>%
    filter(icu_flag == "Y") %>%
    mutate(highest_none_numeric = ifelse(highest_vent_support == "none", 1, 0)) %>%
    mutate(highest_noninvasive_numeric = ifelse(highest_vent_support == "noninvasive", 1, 0)) %>%
    mutate(highest_invasive_numeric = ifelse(highest_vent_support == "invasive", 1, 0)) %>%
    group_by(discharge_year) %>%
    summarize(
      none = sum(highest_none_numeric) / n() * 100,
      noninvasive = sum(highest_noninvasive_numeric) / n() * 100,
      invasive = sum(highest_invasive_numeric) / n() * 100,
      .groups = "drop_last"
    )

  temp_none_delta <- summary(lm(none ~ discharge_year, data = temp_table))$coefficients[2, 1]
  temp_none_p <- summary(lm(none ~ discharge_year, data = temp_table))$coefficients[2, 4]

  temp_noninvasive_delta <- summary(lm(noninvasive ~ discharge_year, data = temp_table))$coefficients[2, 1]
  temp_noninvasive_p <- summary(lm(noninvasive ~ discharge_year, data = temp_table))$coefficients[2, 4]

  temp_invasive_delta <- summary(lm(invasive ~ discharge_year, data = temp_table))$coefficients[2, 1]
  temp_invasive_p <- summary(lm(invasive ~ discharge_year, data = temp_table))$coefficients[2, 4]

  temp_table %>%
    pivot_longer(cols = c(none, noninvasive, invasive), values_to = "n", names_to = "highest_vent_support") %>%
    mutate(highest_vent_support = factor(highest_vent_support, levels = c("invasive", "noninvasive", "none"))) %>%
    ggplot(aes(x = factor(discharge_year), y = n, fill = highest_vent_support)) +
    geom_col(position = "stack") +
    scale_fill_grey(start = 0.6, end = 0.8) +
    geom_text(aes(label = paste(round(n, 1), "%", sep = ""), x = factor(discharge_year), y = n, group = highest_vent_support), position = position_stack(vjust = 0.5), size = 3) +
    theme_bw() +
    labs(title = graph_name, subtitle = "Highest Level of Ventilatory Support Among Patients Admitted to the ICU", caption = paste("The percent of patients admitted to the ICU for none is changing by ", round(temp_none_delta, 0), "% per year, trend p", ifelse(temp_none_p < 0.001, "<0.001", paste("=", round(temp_none_p, 3), sep = "")), ".\n", "The percent of patients admitted to the ICU for noninvasive is changing by ", round(temp_noninvasive_delta, 0), "% per year, trend p", ifelse(temp_noninvasive_p < 0.001, "<0.001", paste("=", round(temp_noninvasive_p, 3), sep = "")), ".\n", "The percent of patients admitted to the ICU for invasive is changing by ", round(temp_invasive_delta, 0), "% per year, trend p", ifelse(temp_invasive_p < 0.001, "<0.001", paste("=", round(temp_invasive_p, 3), sep = "")), ".", sep = "")) +
    xlab("Discharge Year") +
    ylab("% of ICU Admissions") +
    theme(plot.subtitle = element_text(hjust = 0.5), plot.title = element_text(hjust = 0.5), legend.position = "none")
}

icu_ventilation_proportion_all <- icu_proportion_ventilation_function(all_bronchiolitis_diagnoses, "All Bronchiolitis Diagnoses")
icu_ventilation_proportion_primary <- icu_proportion_ventilation_function(primary_bronchiolitis_diagnoses, "Primary Bronchiolitis Diagnoses")
icu_ventilation_proportion_apr_drg <- icu_proportion_ventilation_function(apr_drg_bronchiolitis, "APR-DRG v32 Bronchiolitis Diagnoses")

icu_ventilation_proportion_pittsburgh <- icu_proportion_ventilation_function(pittsburgh_primary_bronchiolitis_diagnoses, "Single-Center Primary Bronchiolitis Diagnoses")

rm(icu_proportion_ventilation_function)
```

```{r display_icu_ventilation_numbers, results="hold", out.width="33%"}
icu_ventilation_number_all
icu_ventilation_number_primary
icu_ventilation_number_apr_drg
rm(icu_ventilation_number_all, icu_ventilation_number_primary, icu_ventilation_number_apr_drg)
```

### Invasive and Non-invasive Ventilation Proportion Among ICU Admissions

```{r display_icu_ventilation_proportions, results="hold", out.width="33%"}
icu_ventilation_proportion_all
icu_ventilation_proportion_primary
icu_ventilation_proportion_apr_drg
rm(icu_ventilation_proportion_all, icu_ventilation_proportion_primary, icu_ventilation_proportion_apr_drg)
```


# Length of Stay

## Commentary {.sidebar}

These graphs show the change in the length of stay over time for patients with bronchiolitis. The second and fourth graphs shows patients grouped by their maximum level of ventilatory support: none (light gray), non-invasive (medium gray), or invasive (dark gray).

Note that the graphs with ICU length of stay (3rd and 4th graph) include only the subsets of patients admitted to the ICU. These patients have longer lengths of stay than those not admitted to an ICU. This is why the median ICU length of stay is as long as the median hospital length of stay.

Overall hospital length of stay is decreasing for patients with oxygen support only and patients with non-invasive ventilatory support. ICU length of stay is decreasing for these same patients.

## LOS Trends {.tabset .tabset-fade}

```{r graph LOS over time}

los_graphing_function <- function(bronchiolitis_table, graph_title) {
  temp_los <- summary(lm(length_of_stay ~ discharge_year, data = bronchiolitis_table))$coefficients[2, 1]
  temp_p <- summary(lm(length_of_stay ~ discharge_year, data = bronchiolitis_table))$coefficients[2, 4]

  temp_plot <- bronchiolitis_table %>%
    ggplot(mapping = aes(x = factor(discharge_year), y = length_of_stay)) +
    geom_boxplot(outlier.color = NA, notch = TRUE, fill = "gray80") +
    coord_cartesian(ylim = c(0, 10)) +
    scale_y_continuous(breaks = seq(0, 10, 2), name = "Hospital Length of Stay") +
    scale_x_discrete(name = "Discharge Year") +
    labs(title = graph_title) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
    labs(subtitle = paste("Length of stay is changing by ", round(temp_los, 3), " days per year, p", ifelse(temp_p < 0.001, " < 0.001", paste("=", round(temp_p, 3))), " for trend.", sep = ""))

  return(temp_plot)
}

los_all <- los_graphing_function(all_bronchiolitis_diagnoses, "All Bronchiolitis Diagnoses")
los_primary <- los_graphing_function(primary_bronchiolitis_diagnoses, "Primary Bronchiolitis Diagnoses")
los_apr_drg <- los_graphing_function(apr_drg_bronchiolitis, "APR DRG v32 Bronchiolitis")

rm(los_graphing_function)

los_by_vent_support_function <- function(bronchiolitis_table, graph_name) {
  temp_none_delta <- summary(lm(length_of_stay ~ discharge_year, data = subset(bronchiolitis_table, highest_vent_support == "none")))$coefficients[2, 1]
  temp_none_p <- summary(lm(length_of_stay ~ discharge_year, data = subset(bronchiolitis_table, highest_vent_support == "none")))$coefficients[2, 4]

  temp_noninvasive_delta <- summary(lm(length_of_stay ~ discharge_year, data = subset(bronchiolitis_table, highest_vent_support == "noninvasive")))$coefficients[2, 1]
  temp_noninvasive_p <- summary(lm(length_of_stay ~ discharge_year, data = subset(bronchiolitis_table, highest_vent_support == "noninvasive")))$coefficients[2, 4]

  temp_invasive_delta <- summary(lm(length_of_stay ~ discharge_year, data = subset(bronchiolitis_table, highest_vent_support == "invasive")))$coefficients[2, 1]
  temp_invasive_p <- summary(lm(length_of_stay ~ discharge_year, data = subset(bronchiolitis_table, highest_vent_support == "invasive")))$coefficients[2, 4]


  temp_plot <- bronchiolitis_table %>%
    group_by(highest_vent_support) %>%
    group_by(discharge_year, .add = TRUE) %>%
    ggplot(mapping = aes(x = factor(discharge_year), y = length_of_stay, fill = highest_vent_support)) +
    geom_boxplot(outlier.colour = NA, notch = TRUE) +
    coord_cartesian(ylim = c(0, 50)) +
    scale_fill_manual(name = "Highest Vent Support", values = c("gray90", "gray75", "gray60")) +
    xlab("Discharge Year") +
    ylab("Hospital Length of Stay (Days)") +
    labs(title = graph_name, caption = paste("LOS for none is changing by ", round(temp_none_delta, 3), " days per year, trend p ", ifelse(temp_none_p < 0.001, "<0.001", temp_none_p), ".\n", "LOS for noninvasive is changing by ", round(temp_noninvasive_delta, 3), " days per year, trend p ", ifelse(temp_noninvasive_p < 0.001, "<0.001", temp_noninvasive_p), ".\n", "LOS for invasive is changing by ", round(temp_invasive_delta, 3), " days per year, trend p ", ifelse(temp_invasive_p < 0.001, "<0.001", paste("= ", round(temp_invasive_p, 3), sep = "")), ".", sep = "")) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(legend.position = "none")

  return(temp_plot)
}

los_vent_all <- los_by_vent_support_function(all_bronchiolitis_diagnoses, "All Bronchiolitis Diagnoses")
los_vent_primary <- los_by_vent_support_function(primary_bronchiolitis_diagnoses, "Primary Bronchiolitis Diagnoses")
los_vent_apr_drg <- los_by_vent_support_function(apr_drg_bronchiolitis, "APR DRG v32 Bronchiolitis")

rm(los_by_vent_support_function)

icu_los_graphing_function <- function(bronchiolitis_table, graph_title) {
  bronchiolitis_table <- subset(bronchiolitis_table, icu_flag == "Y")

  temp_los <- summary(lm(total_days_in_icu ~ discharge_year, data = bronchiolitis_table))$coefficients[2, 1]
  temp_p <- summary(lm(total_days_in_icu ~ discharge_year, data = bronchiolitis_table))$coefficients[2, 4]

  temp_plot <- bronchiolitis_table %>%
    ggplot(mapping = aes(x = factor(discharge_year), y = total_days_in_icu)) +
    geom_boxplot(outlier.color = NA, notch = TRUE, fill = "gray80") +
    coord_cartesian(ylim = c(0, 14)) +
    scale_y_continuous(breaks = seq(0, 14, 2), name = "ICU Length of Stay") +
    scale_x_discrete(name = "Discharge Year") +
    labs(title = graph_title) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5), plot.subtitle = element_text(hjust = 0.5)) +
    labs(subtitle = paste("ICU length of stay is changing by ", round(temp_los, 3), " days per year, p", ifelse(temp_p < 0.001, " < 0.001", paste("=", round(temp_p, 3))), " for trend.", sep = ""), caption = paste("Note: there were ", n_distinct(bronchiolitis_table$discharge_id), " patients in the cohort.", sep = ""))

  return(temp_plot)
}

icu_los_all <- icu_los_graphing_function(all_bronchiolitis_diagnoses, "All Bronchiolitis Diagnoses")
icu_los_primary <- icu_los_graphing_function(primary_bronchiolitis_diagnoses, "Primary Bronchiolitis Diagnoses")
icu_los_apr_drg <- icu_los_graphing_function(apr_drg_bronchiolitis, "APR DRG v32 Bronchiolitis")

rm(icu_los_graphing_function)

icu_los_by_vent_support_function <- function(bronchiolitis_table, graph_name) {
  bronchiolitis_table <- subset(bronchiolitis_table, icu_flag == "Y")

  temp_none_delta <- summary(lm(total_days_in_icu ~ discharge_year, data = subset(bronchiolitis_table, highest_vent_support == "none")))$coefficients[2, 1]
  temp_none_p <- summary(lm(total_days_in_icu ~ discharge_year, data = subset(bronchiolitis_table, highest_vent_support == "none")))$coefficients[2, 4]

  temp_noninvasive_delta <- summary(lm(total_days_in_icu ~ discharge_year, data = subset(bronchiolitis_table, highest_vent_support == "noninvasive")))$coefficients[2, 1]
  temp_noninvasive_p <- summary(lm(total_days_in_icu ~ discharge_year, data = subset(bronchiolitis_table, highest_vent_support == "noninvasive")))$coefficients[2, 4]

  temp_invasive_delta <- summary(lm(total_days_in_icu ~ discharge_year, data = subset(bronchiolitis_table, highest_vent_support == "invasive")))$coefficients[2, 1]
  temp_invasive_p <- summary(lm(total_days_in_icu ~ discharge_year, data = subset(bronchiolitis_table, highest_vent_support == "invasive")))$coefficients[2, 4]


  temp_plot <- bronchiolitis_table %>%
    group_by(highest_vent_support) %>%
    group_by(discharge_year, .add = TRUE) %>%
    ggplot(mapping = aes(x = factor(discharge_year), y = total_days_in_icu, fill = highest_vent_support)) +
    geom_boxplot(outlier.colour = NA, notch = TRUE) +
    coord_cartesian(ylim = c(0, 30)) +
    scale_fill_manual(name = "Highest Vent Support", values = c("gray90", "gray75", "gray60")) +
    xlab("Discharge Year") +
    ylab("ICU Length of Stay (Days)") +
    labs(title = graph_name, caption = paste("ICU LOS for none is changing by ", round(temp_none_delta, 3), " days per year, trend p ", ifelse(temp_none_p < 0.001, "<0.001", temp_none_p), ".\n", "ICU LOS for noninvasive is changing by ", round(temp_noninvasive_delta, 3), " days per year, trend p ", ifelse(temp_noninvasive_p < 0.001, "<0.001", temp_noninvasive_p), ".\n", "ICU LOS for invasive is changing by ", round(temp_invasive_delta, 3), " days per year, trend p ", ifelse(temp_invasive_p < 0.001, "<0.001", paste("= ", round(temp_invasive_p, 3), sep = "")), ".", sep = "")) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(legend.position = "none")

  return(temp_plot)
}

icu_los_vent_all <- icu_los_by_vent_support_function(all_bronchiolitis_diagnoses, "All Bronchiolitis Diagnoses")
icu_los_vent_primary <- icu_los_by_vent_support_function(primary_bronchiolitis_diagnoses, "Primary Bronchiolitis Diagnoses")
icu_los_vent_apr_drg <- icu_los_by_vent_support_function(apr_drg_bronchiolitis, "APR DRG v32 Bronchiolitis")

rm(icu_los_by_vent_support_function)
```

### Hospital Length of Stay

```{r overall los, results = "hold", out.width="33%"}
los_all
los_primary
los_apr_drg
rm(los_all, los_primary, los_apr_drg)
```

### Hospital Length of Stay by Level of Ventilatory Support

```{r los by vent support, results = "hold", out.width="33%"}
los_vent_all
los_vent_primary
los_vent_apr_drg
rm(los_vent_all, los_vent_primary, los_vent_apr_drg)
```

### ICU Length of Stay 

```{r icu_los, results="hold", out.width="33%"}
icu_los_all
icu_los_primary
icu_los_apr_drg
rm(icu_los_all, icu_los_primary, icu_los_apr_drg)
```

### ICU Length of Stay by Level of Ventilatory Support

```{r icu_los_by_vent_support, results="hold", out.width="33%"}
icu_los_vent_all
icu_los_vent_primary
icu_los_vent_apr_drg
rm(icu_los_vent_all, icu_los_vent_primary, icu_los_vent_apr_drg)
```

# Cost

```{r load files with BEA GDP and CMS healthcare expenditure files }

# GDP tables can be found at: https://apps.bea.gov/iTable/iTable.cfm?reqid=19&step=2#reqid=19&step=2&isuri=1&1921=survey
# GDP is: Table 1.1.5. Gross Domestic Product

# NHE tables can be found at: https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/NationalHealthExpendData/NationalHealthAccountsHistorical
# NHE table of interest is: Table 01 National Health Expenditures; Aggregate and Per Capita Amounts

# Please note that the 2019 NHE data uses the PROJECTED value from CMS.gov, as the actual value was not available as of June 10, 2020. The projectional table can be found at: https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/NationalHealthExpendData/NationalHealthAccountsProjected

bea_gdp <- read_csv("Bronchiolitis_GDP_Reports//bea_gdp_annual_report.csv")
bea_gdp <- filter(bea_gdp, X1 == "Gross domestic product") %>%
  pivot_longer(cols = c(`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, `2019`), names_to = "discharge_year", values_to = "bea_gdp_in_billions") %>%
  select(discharge_year, bea_gdp_in_billions) %>%
  mutate(dollars_2010 = bea_gdp_in_billions / bea_gdp_in_billions[1]) %>%
  mutate(discharge_year = as.numeric(discharge_year))

cms_nhe <- readxl::read_xlsx("Bronchiolitis_GDP_Reports//NHE_Summary.xlsx")

nhe_as_gdp_percent <- pivot_longer(cms_nhe, cols = c(2:11)) %>%
  filter(Year == "NHE as GDP %") %>%
  select("discharge_year" = name, "nhe_as_gdp_percent" = value) %>%
  mutate(discharge_year = as.numeric(discharge_year))
nhe_as_gdp_percent$dollars_2010 <- nhe_as_gdp_percent$nhe_as_gdp_percent / nhe_as_gdp_percent$nhe_as_gdp_percent[1]

nhe_per_capita <- pivot_longer(cms_nhe, cols = c(2:11)) %>%
  filter(Year == "NHE in Billions" | Year == "US Population in Millions") %>%
  pivot_wider(id_cols = name, values_from = value, names_from = Year) %>%
  select("discharge_year" = name, "nhe_in_billions" = `NHE in Billions`, "us_population_in_millions" = `US Population in Millions`) %>%
  mutate(discharge_year = as.numeric(discharge_year)) %>%
  mutate(nhe_in_millions = nhe_in_billions * 1000) %>%
  mutate(nhe_per_capita_in_dollars = nhe_in_millions / us_population_in_millions) %>%
  mutate(dollars_2010 = nhe_per_capita_in_dollars / nhe_per_capita_in_dollars[1])

cms_nhe <- pivot_longer(cms_nhe, cols = c(2:11)) %>%
  filter(Year == "NHE in Billions") %>%
  select("discharge_year" = name, "cms_nhe" = value) %>%
  mutate(discharge_year = as.numeric(discharge_year))
```

## Commentary {.sidebar}

These graphs show cost of care over time, adjusting for Centers for Medicare & Medicaid Services (CMS) cost-of living index for a given hospital's zip code. For all grouped graphs, costs are grouped by level of ventilatory support: no ventilatory support (lightest gray), non-invasive ventilatory support (light gray), invasive ventilatory support (dark gray), and both invasive and non-invasive ventilatory support (darkest gray).

The graphs adjusted for the Bureau of Economic Analysis Gross Domestic Product (GDP) are expressed in 2010 dollars. This adjusts for non-specific inflation.

The graphs adjusted for CMS National Healthcare Expenditures per Capita costs are expressed in 2010 dollars. This adjusts for healthcare-specific inflation.

## Inflation Adjusted Costs {.tabset .tabset-fade}

```{r analyze total cost by year adjusting for GDP}

yearly_graph_function <- function(bronchiolitis_table, inflation_table, graph_name, graph_notes) {
  yearly_table <- bronchiolitis_table %>%
    group_by(discharge_year) %>%
    group_by(total_vent_support, add = TRUE) %>%
    summarize(
      "admissions" = n_distinct(discharge_id),
      "patients" = n_distinct(medical_record_number),
      "icu_admissions" = sum(icu_flag == "Y"),
      "ecmo_admissions" = sum(ecmo_flag == "Y"),
      "total_adjusted_charge" = sum(adj_abstract_based_charges, na.rm = TRUE),
      "total_adjusted_cost" = sum(adj_estimated_cost, na.rm = TRUE)
    )

  yearly_table_2 <- bronchiolitis_table %>%
    ungroup() %>%
    group_by(discharge_year) %>%
    summarize(
      "yearly_cost" = sum(adj_estimated_cost, na.rm = TRUE),
      "yearly_admissions" = n_distinct(discharge_id),
      "yearly_median_cost" = median(adj_estimated_cost, na.rm = TRUE)
    )

  yearly_table <- left_join(yearly_table, yearly_table_2, by = "discharge_year")

  yearly_table$yearly_cost[c(seq(2, 38, by = 4), seq(3, 39, by = 4), seq(4, 40, by = 4))] <- NA
  yearly_table$yearly_median_cost[c(seq(2, 38, by = 4), seq(3, 39, by = 4), seq(4, 40, by = 4))] <- NA
  yearly_table$yearly_admissions[c(seq(2, 38, by = 4), seq(3, 39, by = 4), seq(4, 40, by = 4))] <- NA

  yearly_table <- left_join(yearly_table, inflation_table, by = "discharge_year") %>%
    mutate("total_inflation_adjusted_cost" = total_adjusted_cost / (dollars_2010) / 1000000) %>%
    mutate("total_inflation_adjusted_yearly_cost" = yearly_cost / (dollars_2010) / 1000000) %>%
    mutate("total_inflation_adjusted_yearly_median_cost" = yearly_median_cost / (dollars_2010))

  temp_los <- summary(lm(total_inflation_adjusted_yearly_cost ~ discharge_year, data = yearly_table))$coefficients[2, 1]
  temp_p <- summary(lm(total_inflation_adjusted_yearly_cost ~ discharge_year, data = yearly_table))$coefficients[2, 4]

  yearly_plot <- ggplot(data = yearly_table, mapping = aes(x = as.factor(discharge_year), y = total_inflation_adjusted_cost, fill = factor(total_vent_support, levels = c("both", "invasive", "noninvasive", "none")))) +
    geom_col() +
    scale_fill_grey(name = "Type of Ventilator Support", labels = c("Both", "Invasive", "Noninvasive", "None"), start = 0.5, end = 0.9) +
    theme_bw() +
    scale_y_continuous(name = "Annual Cost (millions $)") +
    xlab("Discharge Year") +
    labs(title = graph_name, caption = graph_notes, subtitle = paste("The annual cost of care is changing by $", round(temp_los, 1), " million per year, p", ifelse(temp_p < 0.001, "<0.001", paste("=", round(temp_p, 3), sep = "")), " for trend.", sep = "")) +
    geom_text(aes(label = round(total_inflation_adjusted_yearly_cost, digits = 0), y = total_inflation_adjusted_yearly_cost + total_inflation_adjusted_yearly_cost / 25), size = 3) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5)) +
    theme(plot.caption = element_text(hjust = 0.5)) +
    theme(legend.position = "none")

  return(yearly_plot)
}

bea_gdp_annual_all <- yearly_graph_function(all_bronchiolitis_diagnoses, bea_gdp, "All Bronchiolitis Diagnoses", "Note: Costs are adjusted for CMS cost of living index for hospital zip code.\n Note: Costs are adjusted for Bureau of Economic Analysis\nGlobal Domestic Product and expressed in 2010 dollars.")
bea_gdp_annual_primary <- yearly_graph_function(primary_bronchiolitis_diagnoses, bea_gdp, "Primary Bronchiolitis Diagnoses", "Note: Costs are adjusted for CMS cost of living index for hospital zip code.\n Note: Costs are adjusted for Bureau of Economic Analysis\nGlobal Domestic Product and expressed in 2010 dollars.")
bea_gdp_annual_apr_drg <- yearly_graph_function(apr_drg_bronchiolitis, bea_gdp, "APR-DRG v32 Bronchiolitis Diagnoses", "Note: Costs are adjusted for CMS cost of living index for hospital zip code.\n Note: Costs are adjusted for Bureau of Economic Analysis\nGlobal Domestic Product and expressed in 2010 dollars.")

nhe_per_capita_annual_all <- yearly_graph_function(all_bronchiolitis_diagnoses, nhe_per_capita, "All Bronchiolitis Diagnoses", "Note: Costs are adjusted for CMS cost of living index for hospital zip code.\nNote: Costs are adjusted for  CMS national healthcare expenditures per capita\nand expressed as 2010 dollars.")
nhe_per_capita_annual_primary <- yearly_graph_function(primary_bronchiolitis_diagnoses, nhe_per_capita, "Primary Bronchiolitis Diagnoses", "Note: Costs are adjusted for CMS cost of living index for hospital zip code.\nNote: Costs are adjusted for CMS national healthcare expenditures per capita\nand expressed as 2010 dollars.")
nhe_per_capita_annual_apr_drg <- yearly_graph_function(apr_drg_bronchiolitis, nhe_per_capita, "APR-DRG v32 Bronchiolitis Diagnoses", "Note: Costs are adjusted for CMS cost of living index for hospital zip code.\nNote: Costs are adjusted for CMS national healthcare expenditures per capita\nand expressed as 2010 dollars.")

rm(yearly_graph_function)

cost_per_patient_function <- function(bronchiolitis_table, adjustment_table, graph_name) {
  temp_adjustment_table <- adjustment_table %>% dplyr::select(discharge_year, dollars_2010)
  temp_table <- left_join(bronchiolitis_table, temp_adjustment_table, by = "discharge_year")
  temp_table <- temp_table %>% mutate(inflation_adjusted_cost = adj_estimated_cost / dollars_2010)

  temp_delta <- summary(lm(inflation_adjusted_cost ~ discharge_year, data = temp_table))$coefficients[2, 1]
  temp_p <- summary(lm(inflation_adjusted_cost ~ discharge_year, data = temp_table))$coefficients[2, 4]

  temp_plot <- temp_table %>%
    group_by(discharge_year, .add = TRUE) %>%
    ggplot(mapping = aes(x = factor(discharge_year), y = inflation_adjusted_cost)) +
    geom_boxplot(outlier.colour = NA, fill = "gray60", notch = TRUE) +
    coord_cartesian(ylim = c(0, 25000)) +
    xlab("Discharge Year") +
    ylab("Admission Cost ($)") +
    labs(title = graph_name, subtitle = paste("Mean cost per patient changing by ", round(temp_delta), " dollars per year, trend p ", ifelse(temp_p < 0.001, "<0.001", paste("=", round(temp_p, 3), sep = "")), ".", sep = "")) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5))

  return(temp_plot)
}

per_patient_bea_gdp_all <- cost_per_patient_function(all_bronchiolitis_diagnoses, bea_gdp, "All Bronchiolitis Diagnoses")
per_patient_bea_gdp_primary <- cost_per_patient_function(primary_bronchiolitis_diagnoses, bea_gdp, "Primary Bronchiolitis Diagnoses")
per_patient_bea_gdp_apr_drg <- cost_per_patient_function(apr_drg_bronchiolitis, bea_gdp, "APR DRG v32 Bronchiolitis")

per_patient_nhe_per_capita_all <- cost_per_patient_function(all_bronchiolitis_diagnoses, nhe_per_capita, "All Bronchiolitis Diagnoses")
per_patient_nhe_per_capita_primary <- cost_per_patient_function(primary_bronchiolitis_diagnoses, nhe_per_capita, "Primary Bronchiolitis Diagnoses")
per_patient_nhe_per_capita_apr_drg <- cost_per_patient_function(apr_drg_bronchiolitis, nhe_per_capita, "APR DRG v32 Bronchiolitis")


rm(cost_per_patient_function)

cost_by_vent_support_function <- function(bronchiolitis_table, adjustment_table, graph_name) {
  temp_adjustment_table <- adjustment_table %>% dplyr::select(discharge_year, dollars_2010)
  temp_table <- left_join(bronchiolitis_table, temp_adjustment_table, by = "discharge_year")
  temp_table <- temp_table %>% mutate(inflation_adjusted_cost = adj_estimated_cost / dollars_2010)

  temp_none_delta <- summary(lm(inflation_adjusted_cost ~ discharge_year, data = subset(temp_table, total_vent_support == "none")))$coefficients[2, 1]
  temp_none_p <- summary(lm(inflation_adjusted_cost ~ discharge_year, data = subset(temp_table, total_vent_support == "none")))$coefficients[2, 4]

  temp_noninvasive_delta <- summary(lm(inflation_adjusted_cost ~ discharge_year, data = subset(temp_table, total_vent_support == "noninvasive")))$coefficients[2, 1]
  temp_noninvasive_p <- summary(lm(inflation_adjusted_cost ~ discharge_year, data = subset(temp_table, total_vent_support == "noninvasive")))$coefficients[2, 4]

  temp_invasive_delta <- summary(lm(inflation_adjusted_cost ~ discharge_year, data = subset(temp_table, total_vent_support == "invasive")))$coefficients[2, 1]
  temp_invasive_p <- summary(lm(inflation_adjusted_cost ~ discharge_year, data = subset(temp_table, total_vent_support == "invasive")))$coefficients[2, 4]

  temp_both_delta <- summary(lm(inflation_adjusted_cost ~ discharge_year, data = subset(temp_table, total_vent_support == "both")))$coefficients[2, 1]
  temp_both_p <- summary(lm(inflation_adjusted_cost ~ discharge_year, data = subset(temp_table, total_vent_support == "both")))$coefficients[2, 4]

  temp_plot <- temp_table %>%
    group_by(total_vent_support) %>%
    group_by(discharge_year, .add = TRUE) %>%
    ggplot(mapping = aes(x = factor(discharge_year), y = inflation_adjusted_cost, fill = factor(total_vent_support, levels = c("none", "noninvasive", "invasive", "both")))) +
    geom_boxplot(outlier.colour = NA) +
    coord_cartesian(ylim = c(0, 300000)) +
    scale_fill_manual(name = "vent support", values = c("gray 90", "gray80", "gray70", "gray60")) +
    xlab("Discharge Year") +
    ylab("Admission Cost ($)") +
    labs(title = graph_name, caption = paste("Cost for none is changing by ", round(temp_none_delta), " dollars per year, trend p ", ifelse(temp_none_p < 0.001, "<0.001", temp_none_p), ".\n", "Cost for noninvasive is changing by ", round(temp_noninvasive_delta), " dollars per year, trend p ", ifelse(temp_noninvasive_p < 0.001, "<0.001", round(temp_noninvasive_p, 3)), ".\n", "Cost for invasive is changing by ", round(temp_invasive_delta), " dollars per year, trend p ", ifelse(temp_invasive_p < 0.001, "<0.001", paste("= ", round(temp_invasive_p, 3), sep = "")), ".\n", "Cost for both is changing by ", round(temp_both_delta), " dollars per year, trend p ", ifelse(temp_both_p < 0.001, "<0.001", paste("= ", round(temp_both_p, 3), sep = "")), ".", sep = "")) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(legend.position = "none")

  return(temp_plot)
}

vent_support_bea_gdp_all <- cost_by_vent_support_function(all_bronchiolitis_diagnoses, bea_gdp, "All Bronchiolitis Diagnoses")
vent_support_bea_gdp_primary <- cost_by_vent_support_function(primary_bronchiolitis_diagnoses, bea_gdp, "Primary Bronchiolitis Diagnoses")
vent_support_bea_gdp_apr_drg <- cost_by_vent_support_function(apr_drg_bronchiolitis, bea_gdp, "APR DRG v32 Bronchiolitis")

vent_support_nhe_per_capita_all <- cost_by_vent_support_function(all_bronchiolitis_diagnoses, nhe_per_capita, "All Bronchiolitis Diagnoses")
vent_support_nhe_per_capita_primary <- cost_by_vent_support_function(primary_bronchiolitis_diagnoses, nhe_per_capita, "Primary Bronchiolitis Diagnoses")
vent_support_nhe_per_capita_apr_drg <- cost_by_vent_support_function(apr_drg_bronchiolitis, nhe_per_capita, "APR DRG v32 Bronchiolitis")

rm(cost_by_vent_support_function)
```

### Gross Domestic Product Adjusted Annual Costs

```{r bea gdp annual plots, results="hold", out.width="33%"}
bea_gdp_annual_all
bea_gdp_annual_primary
bea_gdp_annual_apr_drg
rm(bea_gdp_annual_all, bea_gdp_annual_primary, bea_gdp_annual_apr_drg)
```

### National Health Expenditure Per Capita Adjusted Annual Costs

```{r nhe per capita annual plots, results="hold", out.width="33%"}
nhe_per_capita_annual_all
nhe_per_capita_annual_primary
nhe_per_capita_annual_apr_drg
rm(nhe_per_capita_annual_all, nhe_per_capita_annual_primary, nhe_per_capita_annual_apr_drg)
```

### Gross Domestic Product Adjusted Cost Per Patient

```{r bea_gdp_adjusted_per_patient, results="hold", out.width="33%"}
per_patient_bea_gdp_all
per_patient_bea_gdp_primary
per_patient_bea_gdp_apr_drg
rm(per_patient_bea_gdp_all, per_patient_bea_gdp_primary, per_patient_bea_gdp_apr_drg)
```

### National Health Expenditures per Capita Adjusted Cost Per Patient

```{r nhe_per_capita_adjusted_per_patient, results="hold", out.width="33%"}
per_patient_nhe_per_capita_all
per_patient_nhe_per_capita_primary
per_patient_nhe_per_capita_apr_drg
rm(per_patient_nhe_per_capita_all, per_patient_nhe_per_capita_primary, per_patient_nhe_per_capita_apr_drg)
```

### Gross Domestic Product Adjusted Cost by Level of Ventilatory Support

```{r bea_gdp_adjusted_by_vent_support, results="hold", out.width="33%"}
vent_support_bea_gdp_all
vent_support_bea_gdp_primary
vent_support_bea_gdp_apr_drg
rm(vent_support_bea_gdp_all, vent_support_bea_gdp_primary, vent_support_bea_gdp_apr_drg)
```

### National Health Expenditures per Capita Adjusted Cost by Level of Ventilatory Support

```{r nhe_per_capita_adjusted_by_vent_support, results="hold", out.width="33%"}
vent_support_nhe_per_capita_all
vent_support_nhe_per_capita_primary
vent_support_nhe_per_capita_apr_drg
rm(vent_support_nhe_per_capita_all, vent_support_nhe_per_capita_primary, vent_support_nhe_per_capita_apr_drg)
```

# Modeling IMV

```{r testing and training sets}
RNGversion(3.6)
set.seed(97)

# training cohort is even sampling of all hospitals over all discharge years
# 70%:30% :: testing:training split

training_and_testing_subsetting_function <- function(bronchiolitis_table) {
  training_subset <- bronchiolitis_table %>%
    group_by(discharge_year) %>%
    group_by(hospital_number, add = TRUE) %>%
    sample_frac(size = 0.7) %>%
    ungroup()

  testing_subset <- anti_join(bronchiolitis_table, training_subset, by = colnames(bronchiolitis_table))
  test_train_list <- list(training_subset, testing_subset)
  names(test_train_list) <- c("training", "testing")
  return(test_train_list)
}

all_bronchiolitis_diagnoses_training <- training_and_testing_subsetting_function(all_bronchiolitis_diagnoses)$training
all_bronchiolitis_diagnoses_testing <- training_and_testing_subsetting_function(all_bronchiolitis_diagnoses)$testing

primary_bronchiolitis_diagnoses_training <- training_and_testing_subsetting_function(primary_bronchiolitis_diagnoses)$training
primary_bronchiolitis_diagnoses_testing <- training_and_testing_subsetting_function(primary_bronchiolitis_diagnoses)$testing

apr_drg_bronchiolitis_diagnoses_training <- training_and_testing_subsetting_function(apr_drg_bronchiolitis)$training
apr_drg_bronchiolitis_diagnoses_testing <- training_and_testing_subsetting_function(apr_drg_bronchiolitis)$testing

rm(training_and_testing_subsetting_function)
```

```{r develop_stepwise_mv_model}
# Note that since the only continuous predictor in the model is age in months, I did NOT scale this to standardize the odds ratio. This way, the OR represents the effect of a 1 month change in the age of admission (rather than a 1 SD change)

# I did not include transfer flag, ICU flag, or NICU flag because they are not patient characteristics (and because ventilation will be strongly predicted by ICU status - need for ventilation is an indication for ICU admission or transfer to a Children's hospital).

model_development_function <- function(bronchiolitis_training_table) {
  temp_model <- glm(formula = invasive_vent_flag ~ discharge_year + primary_source_of_payment_simplified + gender_title + race_factor + ethnicity_title + admit_age_in_months + cardiovascular_flag + gastrointestinal_flag + hematologic_or_immunologic_flag + malignancy_flag + metabolic_flag + neurologic_and_neuromuscular_flag + other_congenital_or_genetic_defect_flag + premature_and_neonatal_flag + renal_and_urologic_flag + respiratory_flag + technology_dependent_flag + tpn_flag + transplant_flag, data = bronchiolitis_training_table, family = binomial(link = "logit"))

  # limited the scope of step function to force discharge year in as a predictor

  stepwise_temp_model <- step(temp_model, direction = "both", trace = 0, scope = list(lower = as.formula(invasive_vent_flag ~ discharge_year), upper = as.formula(invasive_vent_flag ~ .)))

  return(stepwise_temp_model)
}

mv_model_all <- model_development_function(all_bronchiolitis_diagnoses_training)
mv_model_primary <- model_development_function(primary_bronchiolitis_diagnoses_training)
mv_model_apr_drg <- model_development_function(apr_drg_bronchiolitis_diagnoses_training)
rm(model_development_function)


noninvasive_model_development_function <- function(bronchiolitis_training_table) {
  temp_model <- glm(formula = noninvasive_vent_flag ~ discharge_year + primary_source_of_payment_simplified + gender_title + race_factor + ethnicity_title + admit_age_in_months + cardiovascular_flag + gastrointestinal_flag + hematologic_or_immunologic_flag + malignancy_flag + metabolic_flag + neurologic_and_neuromuscular_flag + other_congenital_or_genetic_defect_flag + premature_and_neonatal_flag + renal_and_urologic_flag + respiratory_flag + technology_dependent_flag + tpn_flag + transplant_flag, data = bronchiolitis_training_table, family = binomial(link = "logit"))

  # limited the scope of step function to force discharge year in as a predictor

  stepwise_temp_model <- step(temp_model, direction = "both", trace = 0, scope = list(lower = as.formula(noninvasive_vent_flag ~ discharge_year), upper = as.formula(noninvasive_vent_flag ~ .)))

  return(stepwise_temp_model)
}

noninvasive_mv_model_all <- noninvasive_model_development_function(all_bronchiolitis_diagnoses_training)

noninvasive_mv_model_primary <- noninvasive_model_development_function(primary_bronchiolitis_diagnoses_training)

noninvasive_mv_model_apr_drg <- noninvasive_model_development_function(apr_drg_bronchiolitis_diagnoses_training)

rm(noninvasive_model_development_function)
```

```{r evaluate_model_characteristics}
library(jtools)

# Note that since the only continuous predictor in the model is age in months, I did NOT scale this to standardize the odds ratio. This way, the OR represents the effect of a 1 month change in the age of admission (rather than a 1 SD change)

model_summary_function <- function(multivariable_model) {
  require(jtools)
  require(tidyverse)
  require(kableExtra)

  temp_summary <- summ(multivariable_model, scale = FALSE, exp = TRUE, confint = TRUE, ci_level = 0.95)
  temp_tibble <- as_tibble(temp_summary[[1]])
  temp_tibble <- (cbind(dimnames(temp_summary[[1]])[[1]], temp_tibble))
  temp_tibble <- temp_tibble %>% transmute(
    "Variable" = `dimnames(temp_summary[[1]])[[1]]`,
    "Odds Ratio" = round(`exp(Est.)`, 3),
    "95% Confidence Interval" = paste("[", round(`2.5%`, 3), ", ", round(`97.5%`, 3), "]", sep = ""),
    "P-Value" = round(p, 3)
  )
  temp_tibble <- temp_tibble %>% mutate("P-Value" = ifelse(`P-Value` == 0, "<0.001", `P-Value`))
  temp_tibble <- temp_tibble %>%
    mutate("Variable" = case_when(
      Variable == "discharge_year" ~ "Discharge Year",
      Variable == "primary_source_of_payment_simplifiedGovernment" ~ "Insurance: Government",
      Variable == "primary_source_of_payment_simplifiedOther" ~ "Insurance: Other",
      Variable == "race_factorother" ~ "Race: Other",
      Variable == "race_factorblack" ~ "Race: Black",
      Variable == "ethnicity_titleHispanic or Latino" ~ "Ethnicity: Hispanic",
      Variable == "ethnicity_titleUnknown" ~ "Ethnicity: Unknown",
      Variable == "admit_age_in_months" ~ "Admit Age (months)",
      Variable == "cardiovascular_flagY" ~ "CCC: Cardiovascular",
      Variable == "gastrointestinal_flagY" ~ "CCC: Gastrointestinal",
      Variable == "hematologic_or_immunologic_flagY" ~ "CCC: Hematologic/Immunologic",
      Variable == "malignancy_flagY" ~ "CCC: Malignancy",
      Variable == "metabolic_flagY" ~ "CCC: Metabolic",
      Variable == "neurologic_and_neuromuscular_flagY" ~ "CCC: Neurologic",
      Variable == "other_congenital_or_genetic_defect_flagY" ~ "CCC: Congenital / Genetic Defect",
      Variable == "premature_and_neonatal_flagY" ~ "CCC: Prematuriity / Neonatal",
      Variable == "renal_and_urologic_flagY" ~ "CCC: Renal / Urologic",
      Variable == "respiratory_flagY" ~ "CCC: Respiratory",
      Variable == "premature_and_neonatal_flagY" ~ "CCC: Prematuriity / Neonatal",
      Variable == "technology_dependent_flagY" ~ "CCC: Technology Dependent",
      Variable == "tpn_flagY" ~ "CCC: TPN Dependent",
      TRUE ~ Variable
    ))

  return(knitr::kable(temp_tibble) %>%
    kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), fixed_thead = F))
}

summary_all <- model_summary_function(mv_model_all)
summary_prmary <- model_summary_function(mv_model_primary)
summary_apr_drg <- model_summary_function(mv_model_apr_drg)

noninvasive_summary_all <- model_summary_function(noninvasive_mv_model_all)
noninvasive_summary_prmary <- model_summary_function(noninvasive_mv_model_primary)
noninvasive_summary_apr_drg <- model_summary_function(noninvasive_mv_model_apr_drg)

rm(model_summary_function)
```

```{r evaluate_model_discrimination}

model_discrimination_function <- function(model, bronchiolitis_testing_table) {
  require(precrec)
  require(pROC)

  outcome_table <- as_tibble(cbind(predict(model, newdata = bronchiolitis_testing_table, type = "response"), bronchiolitis_testing_table$invasive_vent_numeric)) %>%
    rename("predicted" = V1, "actual" = V2)

  roc_ci <- pROC::ci(pROC::roc(data = outcome_table, predictor = predicted, response = actual))

  roc_plot <- autoplot(evalmod(scores = outcome_table$predicted, labels = outcome_table$actual), curvetype = "ROC", show_legend = FALSE) +
    scale_color_grey() +
    labs(title = "Receiver Operating Characteristic Plot", subtitle = paste("AUC [DeLong 95% CI] is: ", round(roc_ci[2], 3), " [", round(roc_ci[1], 3), ", ", round(roc_ci[3], 3), "].", sep = "")) +
    xlab("False Positive Rate (1 - Specificity)") +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5))

  pr_plot <- autoplot(evalmod(scores = outcome_table$predicted, labels = outcome_table$actual), curvetype = "PRC", show_legend = FALSE) +
    scale_color_grey() +
    labs(title = "Precision Recall Plot", subtitle = paste("AUC is: ", round(precrec::auc(evalmod(scores = outcome_table$predicted, labels = outcome_table$actual))[2, 4], 3), sep = "")) +
    ylab("Precision (Positive Predictive Value)") +
    xlab("Recall (Sensitivity)") +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5))

  return(list(outcome_table, roc_plot, pr_plot))
}

prediction_table_all <- model_discrimination_function(mv_model_all, all_bronchiolitis_diagnoses_testing)[[1]]
roc_plot_all <- model_discrimination_function(mv_model_all, all_bronchiolitis_diagnoses_testing)[[2]]
pr_plot_all <- model_discrimination_function(mv_model_all, all_bronchiolitis_diagnoses_testing)[[3]]

prediction_table_primary <- model_discrimination_function(mv_model_primary, primary_bronchiolitis_diagnoses_testing)[[1]]
roc_plot_primary <- model_discrimination_function(mv_model_primary, primary_bronchiolitis_diagnoses_testing)[[2]]
pr_plot_primary <- model_discrimination_function(mv_model_primary, primary_bronchiolitis_diagnoses_testing)[[3]]

prediction_table_apr_drg <- model_discrimination_function(mv_model_apr_drg, apr_drg_bronchiolitis_diagnoses_testing)[[1]]
roc_plot_apr_drg <- model_discrimination_function(mv_model_apr_drg, apr_drg_bronchiolitis_diagnoses_testing)[[2]]
pr_plot_apr_drg <- model_discrimination_function(mv_model_apr_drg, apr_drg_bronchiolitis_diagnoses_testing)[[3]]
```

```{r noninvasive_evaluate_model_discrimination}

noninvasive_model_discrimination_function <- function(model, bronchiolitis_testing_table) {
  require(precrec)
  require(pROC)

  outcome_table <- as_tibble(cbind(predict(model, newdata = bronchiolitis_testing_table, type = "response"), bronchiolitis_testing_table$noninvasive_vent_numeric)) %>%
    rename("predicted" = V1, "actual" = V2)

  roc_ci <- pROC::ci(pROC::roc(data = outcome_table, predictor = predicted, response = actual))

  roc_plot <- autoplot(evalmod(scores = outcome_table$predicted, labels = outcome_table$actual), curvetype = "ROC", show_legend = FALSE) +
    scale_color_grey() +
    labs(title = "Receiver Operating Characteristic Plot", subtitle = paste("AUC [DeLong 95% CI] is: ", round(roc_ci[2], 3), " [", round(roc_ci[1], 3), ", ", round(roc_ci[3], 3), "].", sep = "")) +
    xlab("False Positive Rate (1 - Specificity)") +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5))

  pr_plot <- autoplot(evalmod(scores = outcome_table$predicted, labels = outcome_table$actual), curvetype = "PRC", show_legend = FALSE) +
    scale_color_grey() +
    labs(title = "Precision Recall Plot", subtitle = paste("AUC is: ", round(precrec::auc(evalmod(scores = outcome_table$predicted, labels = outcome_table$actual))[2, 4], 3), sep = "")) +
    ylab("Precision (Positive Predictive Value)") +
    xlab("Recall (Sensitivity)") +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5))

  return(list(outcome_table, roc_plot, pr_plot))
}

noninvasive_prediction_table_all <- noninvasive_model_discrimination_function(noninvasive_mv_model_all, all_bronchiolitis_diagnoses_testing)[[1]]
noninvasive_roc_plot_all <- noninvasive_model_discrimination_function(noninvasive_mv_model_all, all_bronchiolitis_diagnoses_testing)[[2]]
noninvasive_pr_plot_all <- noninvasive_model_discrimination_function(noninvasive_mv_model_all, all_bronchiolitis_diagnoses_testing)[[3]]

noninvasive_prediction_table_primary <- noninvasive_model_discrimination_function(noninvasive_mv_model_primary, primary_bronchiolitis_diagnoses_testing)[[1]]
noninvasive_roc_plot_primary <- noninvasive_model_discrimination_function(noninvasive_mv_model_primary, primary_bronchiolitis_diagnoses_testing)[[2]]
noninvasive_pr_plot_primary <- noninvasive_model_discrimination_function(noninvasive_mv_model_primary, primary_bronchiolitis_diagnoses_testing)[[3]]

noninvasive_prediction_table_apr_drg <- noninvasive_model_discrimination_function(noninvasive_mv_model_apr_drg, apr_drg_bronchiolitis_diagnoses_testing)[[1]]
noninvasive_roc_plot_apr_drg <- noninvasive_model_discrimination_function(noninvasive_mv_model_apr_drg, apr_drg_bronchiolitis_diagnoses_testing)[[2]]
noninvasive_pr_plot_apr_drg <- noninvasive_model_discrimination_function(noninvasive_mv_model_apr_drg, apr_drg_bronchiolitis_diagnoses_testing)[[3]]

rm(noninvasive_model_discrimination_function)
```

## Commentary {.sidebar}

To the right are results of multivariate logistic regression with an outcome of invasive mechanical ventilation. Models were developed by including race/ethnicity, age, sex, insurance status, complex chronic condition flags and discharge year. Automated backward stepwise selection was performed to minimize Akaike Information Criterion. Discharge year was forced into the model as it was a variable of interest.

## MV Logistic Regression {.tabset .tabset-fade}

### All Bronchiolitis Diagnoses Model Characteristics

```{r model_summary_all, results="hold"}
summary_all
```

### All Bronchiolitis Diagnoses Model Discrimination and Calibration

```{r model_performance_all, results="hold", out.width="50%"}
roc_plot_all
pr_plot_all

library(givitiR)
cb <- plot(givitiCalibrationBelt(
  o = prediction_table_all$actual,
  e = prediction_table_all$predicted,
  devel = "external"
),
colBis = "black",
main = paste("MV Regression", "Calibration Belt"),
xlab = "Predicted Ventilation",
ylab = "Observed Ventilation"
)

rm(roc_plot_all, pr_plot_all, cb, summary_all)
```

### Primary Bronchiolitis Diagnoses Model Characteristics

```{r model_summary_primary, results="hold"}
summary_prmary
```

### Primary Bronchiolitis Diagnoses Model Discrimination and Calibration

```{r model_performance_primary, results="hold", out.width="50%"}
roc_plot_primary
pr_plot_primary

library(givitiR)
cb <- plot(givitiCalibrationBelt(
  o = prediction_table_primary$actual,
  e = prediction_table_primary$predicted,
  devel = "external"
),
colBis = "black",
main = paste("MV Regression", "Calibration Belt"),
xlab = "Predicted Ventilation",
ylab = "Observed Ventilation"
)

rm(roc_plot_primary, pr_plot_primary, cb, summary_primary)
```

### APR-DRG v32 Bronchiolitis Diagnoses Model Characteristics

```{r model_summary_apr_drg, results="hold"}
summary_apr_drg
```

### APR-DRG v32 Bronchiolitis Diagnoses Model Discrimination and Calibration

```{r model_performance_apr_drg, results="hold", out.width="50%"}
roc_plot_apr_drg
pr_plot_apr_drg

library(givitiR)
cb <- plot(givitiCalibrationBelt(
  o = prediction_table_apr_drg$actual,
  e = prediction_table_apr_drg$predicted,
  devel = "external"
),
colBis = "black",
main = paste("MV Regression", "Calibration Belt"),
xlab = "Predicted Ventilation",
ylab = "Observed Ventilation"
)

rm(roc_plot_apr_drg, pr_plot_apr_drg, cb, summary_apr_drg)
```

# Modeling NIV

## Commentary {.sidebar}

To the right are results of multivariate logistic regression with an outcome of non-invasive ventilation. Models were developed by including race/ethnicity, age, sex, insurance status, complex chronic condition flags and discharge year. Automated backward stepwise selection was performed to minimize Akaike Information Criterion. Discharge year was forced into the model as it was a variable of interest.

## MV Logistic Regression {.tabset .tabset-fade}

### All Bronchiolitis Diagnoses Model Characteristics

```{r noninvasive_model_summary_all, results="hold"}
noninvasive_summary_all
```

### All Bronchiolitis Diagnoses Model Discrimination and Calibration

```{r noninvasive_model_performance_all, results="hold", out.width="50%"}
noninvasive_roc_plot_all
noninvasive_pr_plot_all

library(givitiR)
cb <- plot(givitiCalibrationBelt(
  o = noninvasive_prediction_table_all$actual,
  e = noninvasive_prediction_table_all$predicted,
  devel = "external"
),
colBis = "black",
main = paste("MV Regression", "Calibration Belt"),
xlab = "Predicted Ventilation",
ylab = "Observed Ventilation"
)

rm(noninvasive_roc_plot_all, noninvasive_pr_plot_all, cb, noninvasive_summary_all)
```

### Primary Bronchiolitis Diagnoses Model Characteristics

```{r noninvasive_model_summary_primary, results="hold"}
noninvasive_summary_prmary
```

### Primary Bronchiolitis Diagnoses Model Discrimination and Calibration

```{r noninvasive_model_performance_primary, results="hold", out.width="50%"}
noninvasive_roc_plot_primary
noninvasive_pr_plot_primary

library(givitiR)
cb <- plot(givitiCalibrationBelt(
  o = noninvasive_prediction_table_primary$actual,
  e = noninvasive_prediction_table_primary$predicted,
  devel = "external"
),
colBis = "black",
main = paste("MV Regression", "Calibration Belt"),
xlab = "Predicted Ventilation",
ylab = "Observed Ventilation"
)

rm(noninvasive_roc_plot_primary, noninvasive_pr_plot_primary, cb, noninvasive_summary_primary)
```

### APR-DRG v32 Bronchiolitis Diagnoses Model Characteristics

```{r noninvasive_model_summary_apr_drg, results="hold"}
noninvasive_summary_apr_drg
```

### APR-DRG v32 Bronchiolitis Diagnoses Model Discrimination and Calibration

```{r noninvasive_model_performance_apr_drg, results="hold", out.width="50%"}
noninvasive_roc_plot_apr_drg
noninvasive_pr_plot_apr_drg

library(givitiR)
cb <- plot(givitiCalibrationBelt(
  o = noninvasive_prediction_table_apr_drg$actual,
  e = noninvasive_prediction_table_apr_drg$predicted,
  devel = "external"
),
colBis = "black",
main = paste("MV Regression", "Calibration Belt"),
xlab = "Predicted Ventilation",
ylab = "Observed Ventilation"
)

rm(noninvasive_roc_plot_apr_drg, noninvasive_pr_plot_apr_drg, cb, noninvasive_summary_apr_drg)
```

# Single-Center Sub-analysis

## Commentary {.sidebar}

At our center, ICU admission rates in patients with a primary diagnosis of bronchiolitis outpaced the growth in ICU admission rates overall.

For the ventilation graphs, patients are grouped according to maximum level of ventilatory support: none (light gray), non-invasive (medium gray), or invasive (dark gray).

ICU admissions for invasive ventilatory support increased by an average of 1.1 patients per year, while ICU admissions for no ventilatory support (high flow nasal cannula) increased by an average of 13.5 patients per year.

For the severity of illness graphs, data was available from 2010 to 2018. Patients receiving no ventiltory support (high flow nasal cannula) and noninvasive ventilation were grouped together (light gray) and compared with patients receving invasive ventilation (dark gray).

## Pittsburgh {.tabset .tabset-fade}

### Percentage Admitted To The ICU

```{r pittsburgh_icu_admissions, results="hold", out.width="50%"}
pittsburgh_bronchiolitis_icu_yearly_graph
pittsburgh_all_admissions_icu_yearly_graph
rm(pittsburgh_bronchiolitis_icu_yearly_graph, pittsburgh_all_admissions_icu_yearly_graph)
```

### Invasive and Non-invasive Ventilation Among ICU Admissions

```{r pittsburgh_icu_ventilation, results="hold", out.width="50%"}
icu_ventilation_number_pittsburgh
icu_ventilation_proportion_pittsburgh
rm(icu_ventilation_number_pittsburgh, icu_ventilation_proportion_pittsburgh)
```

### Modified PELOD Among ICU Admissions

```{r render_pittsburgh_pelod, results="hold", fig.width=4}
render_tiff_function <- function(image_path) {
  require(tiff)
  require(grid)
  temp <- readTIFF(image_path)
  return(grid.raster(temp))
}

render_tiff_function("Bronchiolitis_CHP_Subset_PELOD_Analysis/primary_bronchiolitis_modified_pelod_scores_with_numbers_no_legend.tiff")
```

### PRISM Among ICU Admissions

```{r render_pittsburgh_prism, results="hold", fig.width=4}
render_tiff_function("Bronchiolitis_CHP_Subset_PRISM_Analysis/primary_bronchiolitis_prism_scores_with_probability_no_legend.tiff")

rm(render_tiff_function)
```

```{r session_info}
sessionInfo()
```

