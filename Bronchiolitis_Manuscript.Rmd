---
title: "Bronchiolitis Manuscript"
author: "Jonathan Pelletier"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
    code_folding: hide
    fig_asp: 0.618
    fig_width: 7
    number_sections: yes
    theme: cosmo
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
---

# Setup, File Loading, Data Processing and Cleaning

```{r setup, include=FALSE}
knitr::opts_chunk$set(knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, results = "hide"))
library(tidyverse)
library(flexdashboard)
```

```{r file loading}
reading_function <- function(csv_file) {
  read_csv(csv_file,
    col_types =
      cols(
        `Hospital Number` = col_double(),
        `Hospital City` = col_factor(),
        `Medical Record Number` = col_double(),
        `Discharge ID` = col_double(),
        `Billing Number` = col_character(),
        `Admit Date` = col_character(),
        `Admit Hour` = col_double(),
        `Admit Hour Indicator Title` = col_factor(),
        `Discharge Date` = col_character(),
        `Length Of Stay` = col_double(),
        `Priority Of Admission Title` = col_factor(),
        `Source Of Admission Title` = col_factor(),
        `Patient Type` = col_double(),
        `Patient Type Title` = col_factor(),
        `Primary Source Of Payment` = col_double(),
        `Primary Source Of Payment Title` = col_factor(),
        `Principal Dx (ICD)` = col_factor(),
        `Principal Dx Version (ICD)` = col_double(),
        `Principal Dx Title (ICD)` = col_factor(),
        `Gender Title` = col_factor(),
        `Race - American Indian` = col_factor(),
        `Race - Asian` = col_factor(),
        `Race - Black` = col_factor(),
        `Race - Other` = col_factor(),
        `Race - Pacific Islander` = col_factor(),
        `Race - White` = col_factor(),
        `Ethnicity Title` = col_factor(),
        `Admit Age In Days` = col_double(),
        `Admit Age In Months` = col_double(),
        `Complex Chronic Condition Flag` = col_factor(),
        `Cardiovascular Flag` = col_factor(),
        `Gastrointestinal Flag` = col_factor(),
        `Hematologic or Immunologic Flag` = col_factor(),
        `Malignancy Flag` = col_factor(),
        `Mental Health Disorder Flag` = col_factor(),
        `Metabolic Flag` = col_factor(),
        `Neurologic and Neuromuscular Flag` = col_factor(),
        `NICU Flag` = col_factor(),
        `Other Congenital or Genetic Defect Flag` = col_factor(),
        `Premature and Neonatal Flag` = col_factor(),
        `Renal and Urologic Flag` = col_factor(),
        `Respiratory Flag` = col_factor(),
        `Secondary Dx Mental Health Disorder Flag` = col_factor(),
        `Technology Dependent Flag` = col_factor(),
        `TPN Flag` = col_factor(),
        `Transplant Flag` = col_factor(),
        `ICU Flag` = col_factor(),
        `Total Days In ICU` = col_double(),
        `Mechanical Vent Flag` = col_factor(),
        `ECMO Flag` = col_factor(),
        `Discharge Mortality Flag` = col_factor(),
        `Disposition Title` = col_factor(),
        `Adj Abstract Based Charges` = col_character(),
        `Adj Estimated Cost` = col_character(),
        `Abstract Based Charges` = col_character(),
        `Estimated Cost` = col_character()
      )
  )
}

all_bronchiolitis_diagnoses <- reading_function("Bronchiolitis_PHIS_Reports/All_Bronchiolitis.csv")
primary_bronchiolitis_diagnoses <- reading_function("Bronchiolitis_PHIS_Reports/Bronchiolitis_Primary_Diagnosis.csv")
apr_drg_bronchiolitis <- reading_function("Bronchiolitis_PHIS_Reports/Bronchiolitis_APR-DRG_v32.csv")

# replace all spaces in names with underscores, remove special characters and double spaces, change to lowercase
names(all_bronchiolitis_diagnoses) <- names(all_bronchiolitis_diagnoses) %>%
  stringr::str_replace_all("\\s", "_") %>%
  stringr::str_replace_all("-", "") %>%
  stringr::str_replace_all("\\(", "_") %>%
  stringr::str_replace_all("\\)", "") %>%
  stringr::str_replace_all("__", "_") %>%
  tolower()

names(primary_bronchiolitis_diagnoses) <- names(primary_bronchiolitis_diagnoses) %>%
  stringr::str_replace_all("\\s", "_") %>%
  stringr::str_replace_all("-", "") %>%
  stringr::str_replace_all("\\(", "_") %>%
  stringr::str_replace_all("\\)", "") %>%
  stringr::str_replace_all("__", "_") %>%
  tolower()

names(apr_drg_bronchiolitis) <- names(apr_drg_bronchiolitis) %>%
  stringr::str_replace_all("\\s", "_") %>%
  stringr::str_replace_all("-", "") %>%
  stringr::str_replace_all("\\(", "_") %>%
  stringr::str_replace_all("\\)", "") %>%
  stringr::str_replace_all("__", "_") %>%
  tolower()

cat("The column names of your all bronchiolitis diagnoses spreadsheet are as follows: \n \n")
names(all_bronchiolitis_diagnoses)

cat("\n \nThe column names of your primary bronchiolitis diagnoses spreadsheet are as follows: \n \n")
names(primary_bronchiolitis_diagnoses)

cat("\n \nThe column names of your APR-DRG v32 bronchiolitis spreadsheet are as follows: \n \n")
names(apr_drg_bronchiolitis)
rm(reading_function)
```

```{r insurance rename function}

insurance_rename_function <- function(bronchiolitis_table) {
  temp_table <- bronchiolitis_table %>% mutate(primary_source_of_payment_title = as.character(primary_source_of_payment_title))
  temp_table <- temp_table %>% mutate(primary_source_of_payment_simplified = case_when(
    # Commercial
    primary_source_of_payment_title == "Commercial Other" ~ "Commercial",
    primary_source_of_payment_title == "Commercial HMO" ~ "Commercial",
    primary_source_of_payment_title == "Commercial PPO" ~ "Commercial",
    # Government
    primary_source_of_payment_title == "In-State Medicaid (managed care)" ~ "Government",
    primary_source_of_payment_title == "In-State Medicaid (other)" ~ "Government",
    primary_source_of_payment_title == "Out-of-State Medicaid (all)" ~ "Government",
    primary_source_of_payment_title == "TRICARE" ~ "Government",
    primary_source_of_payment_title == "Other Government" ~ "Government",
    primary_source_of_payment_title == "Medicare" ~ "Government",
    primary_source_of_payment_title == "CHIP" ~ "Government",
    # Other
    primary_source_of_payment_title == "Other Payor" ~ "Other",
    primary_source_of_payment_title == "Self Pay" ~ "Other",
    primary_source_of_payment_title == "Unknown" ~ "Other",
    primary_source_of_payment_title == "Hospital chose not to bill for this encounter" ~ "Other",
    primary_source_of_payment_title == "Charity" ~ "Other"
  ))
  temp_table <- temp_table %>% mutate(primary_source_of_payment_simplified = as.factor(primary_source_of_payment_simplified))
  return(temp_table)
}

all_bronchiolitis_diagnoses <- insurance_rename_function(all_bronchiolitis_diagnoses)
primary_bronchiolitis_diagnoses <- insurance_rename_function(primary_bronchiolitis_diagnoses)
apr_drg_bronchiolitis <- insurance_rename_function(apr_drg_bronchiolitis)

cat("The following is a summary of the simplified all bronchiolitis insurance column: \n \n")
summary(all_bronchiolitis_diagnoses$primary_source_of_payment_simplified)

cat("\n \nThe following is a summary of the simplified primary bronchiolitis insurance column: \n \n")
summary(primary_bronchiolitis_diagnoses$primary_source_of_payment_simplified)

cat("\n \nThe following is a summary of the simplified APR-DRG bronchiolitis insurance column: \n \n")
summary(apr_drg_bronchiolitis$primary_source_of_payment_simplified)

rm(insurance_rename_function)
```


```{r generate a transfer flag}
# note that this flag includes transfers from all sources (hospitals, SNF, clinic, etc)

transfer_flag_function <- function(bronchiolitis_table) {
  transfers <- grep("transfer", bronchiolitis_table$source_of_admission_title)
  transfers <- all_bronchiolitis_diagnoses[transfers, ]
  transfers$transfer_flag <- "Y"
  transfers <- transfers %>% select(discharge_id, transfer_flag)
  transfer_table <- left_join(bronchiolitis_table, transfers, by = "discharge_id")
  transfer_table <- transfer_table %>% mutate(transfer_flag = as.factor(replace_na(transfer_flag, "N")))
  return(transfer_table)
}

all_bronchiolitis_diagnoses <- transfer_flag_function(all_bronchiolitis_diagnoses)
primary_bronchiolitis_diagnoses <- transfer_flag_function(primary_bronchiolitis_diagnoses)
apr_drg_bronchiolitis <- transfer_flag_function(apr_drg_bronchiolitis)

rm(transfer_flag_function)
```

```{r generate single race factor}
race_factor_function <- function(bronchiolitis_table) {
  race_table <- bronchiolitis_table
  race_table <- race_table %>% mutate(race_factor = case_when(
    race_american_indian == "Y" & race_asian == "N" & race_black == "N" & race_other == "N" & race_pacific_islander == "N" & race_white == "N" ~ "american_indian",
    race_american_indian == "N" & race_asian == "Y" & race_black == "N" & race_other == "N" & race_pacific_islander == "N" & race_white == "N" ~ "asian",
    race_american_indian == "N" & race_asian == "N" & race_black == "Y" & race_other == "N" & race_pacific_islander == "N" & race_white == "N" ~ "black",
    race_american_indian == "N" & race_asian == "N" & race_black == "Y" & race_other == "N" & race_pacific_islander == "N" & race_white == "N" ~ "pacific_islander",
    race_american_indian == "N" & race_asian == "N" & race_black == "N" & race_other == "N" & race_pacific_islander == "N" & race_white == "Y" ~ "white",
    TRUE ~ "other"
  ))
  race_table$race_factor <- as.factor(race_table$race_factor)
  race_table$race_factor <- fct_lump(race_table$race_factor, n = 3, other_level = "other") # collapse race into white, black, other
  race_table$race_factor <- fct_infreq(race_table$race_factor) # order by frequency
  return(race_table)
}

all_bronchiolitis_diagnoses <- race_factor_function(all_bronchiolitis_diagnoses)
cat("Here is a summary of the all bronchiolitis diagnoses race factor column:\n", summary(all_bronchiolitis_diagnoses$race_factor))

primary_bronchiolitis_diagnoses <- race_factor_function(primary_bronchiolitis_diagnoses)
cat("\n\nHere is a summary of the primary bronchiolitis diagnoses race factor column:\n", summary(primary_bronchiolitis_diagnoses$race_factor))

apr_drg_bronchiolitis <- race_factor_function(apr_drg_bronchiolitis)
cat("\n\nHere is a summary of the APR-DRG v32 bronchiolitis diagnoses race factor column:\n", summary(apr_drg_bronchiolitis$race_factor))
rm(race_factor_function)
```

```{r generate discharge year column for grouping}
library(lubridate)

discharge_year_function <- function(bronchiolitis_table) {
  discharge_year_table <- bronchiolitis_table %>%
    mutate(discharge_date = mdy(discharge_date)) %>%
    mutate(discharge_year = as.numeric(format(discharge_date, "%Y")))
  return(discharge_year_table)
}

all_bronchiolitis_diagnoses <- discharge_year_function(all_bronchiolitis_diagnoses)
primary_bronchiolitis_diagnoses <- discharge_year_function(primary_bronchiolitis_diagnoses)
apr_drg_bronchiolitis <- discharge_year_function(apr_drg_bronchiolitis)

rm(discharge_year_function)
```

```{r change cost column to numeric}

cost_cleaning_function <- function(cost_column, cost_column_name) {
  cost_temp <- suppressWarnings(str_remove(cost_column, "\\$") %>% str_remove(",") %>% as.numeric())
  costs_missing <- length(subset(cost_temp, is.na(cost_temp)))
  cat("There are", costs_missing, "patients with missing cost data in", cost_column_name, "\n These values have been set to NA.\n \n")
  return(cost_temp)
}

# Apply cost cleaning to all bronchiolitis table
all_bronchiolitis_diagnoses$estimated_cost <- cost_cleaning_function(all_bronchiolitis_diagnoses$estimated_cost, "all_bronchiolitis_diagnoses$estimated_cost")

all_bronchiolitis_diagnoses$adj_estimated_cost <- cost_cleaning_function(all_bronchiolitis_diagnoses$adj_estimated_cost, "all_bronchiolitis_diagnoses$adj_estimated_cost")

all_bronchiolitis_diagnoses$abstract_based_charges <- cost_cleaning_function(all_bronchiolitis_diagnoses$abstract_based_charges, "all_bronchiolitis_diagnoses$abstract_based_charges")

all_bronchiolitis_diagnoses$adj_abstract_based_charges <- cost_cleaning_function(all_bronchiolitis_diagnoses$adj_abstract_based_charges, "all_bronchiolitis_diagnoses$adj_abstract_based_charges")


# Apply cost cleaning to primary bronchiolitis diagnosis table
primary_bronchiolitis_diagnoses$estimated_cost <- cost_cleaning_function(primary_bronchiolitis_diagnoses$estimated_cost, "primary_bronchiolitis_diagnoses$estimated_cost")

primary_bronchiolitis_diagnoses$adj_estimated_cost <- cost_cleaning_function(primary_bronchiolitis_diagnoses$adj_estimated_cost, "primary_bronchiolitis_diagnoses$adj_estimated_cost")

primary_bronchiolitis_diagnoses$abstract_based_charges <- cost_cleaning_function(primary_bronchiolitis_diagnoses$abstract_based_charges, "primary_bronchiolitis_diagnoses$abstract_based_charges")

primary_bronchiolitis_diagnoses$adj_abstract_based_charges <- cost_cleaning_function(primary_bronchiolitis_diagnoses$adj_abstract_based_charges, "primary_bronchiolitis_diagnoses$adj_abstract_based_charges")


# Apply cost cleaning to APR-DRG bronchiolitis table
apr_drg_bronchiolitis$estimated_cost <- cost_cleaning_function(apr_drg_bronchiolitis$estimated_cost, "apr_drg_bronchiolitis$estimated_cost")

apr_drg_bronchiolitis$adj_estimated_cost <- cost_cleaning_function(apr_drg_bronchiolitis$adj_estimated_cost, "apr_drg_bronchiolitis$adj_estimated_cost")

apr_drg_bronchiolitis$abstract_based_charges <- cost_cleaning_function(apr_drg_bronchiolitis$abstract_based_charges, "apr_drg_bronchiolitis$abstract_based_charges")

apr_drg_bronchiolitis$adj_abstract_based_charges <- cost_cleaning_function(apr_drg_bronchiolitis$adj_abstract_based_charges, "apr_drg_bronchiolitis$adj_abstract_based_charges")

rm(cost_cleaning_function)
```

```{r load files with invasive and noninvasive ventilation codes, generate columns for invasive and noninvasive ventilation}

# The codes used to define invasive and noninvasive mechanical ventilation here are from supplemental table 5 of Fujiogi M, Goto T, Yasunaga H, et al. Trends in Bronchiolitis Hospitalizations in the United States: 2000-2016. Pediatrics. 2019.

# There is one important exception to the above: ICD-9-CM code 93.01 (PT evaluation) in the above reference was substituted for 96.01 (insert NP airway) below - I assumed that the citation had a typo in using a PT evaluation code as diagnostic for mechanical ventilation.

reading_ventilation_codes_function <- function(invasive_ventilation_csv_file, non_invasive_ventilation_csv_file, bronchiolits_table, bronchiolits_table_name) {
  invasive_ventilation <- read_csv(invasive_ventilation_csv_file,
    col_types =
      cols(
        `Hospital Number` = col_double(),
        `Hospital City` = col_factor(),
        `Medical Record Number` = col_double(),
        `Discharge ID` = col_double(),
        `Billing Number` = col_character(),
        `Px Version` = col_double(),
        `Px Code - Title (ICD)` = col_factor()
      )
  )
  noninvasive_ventilation <- read_csv(non_invasive_ventilation_csv_file,
    col_types =
      cols(
        `Hospital Number` = col_double(),
        `Hospital City` = col_factor(),
        `Medical Record Number` = col_double(),
        `Discharge ID` = col_double(),
        `Billing Number` = col_character(),
        `Px Version` = col_double(),
        `Px Code - Title (ICD)` = col_factor()
      )
  )
  invasive_ventilation$invasive_vent_flag <- "Y"
  invasive_ventilation <- invasive_ventilation %>%
    select("discharge_id" = `Discharge ID`, invasive_vent_flag)
  invasive_ventilation <- invasive_ventilation[!duplicated(invasive_ventilation$discharge_id), ]
  noninvasive_ventilation$noninvasive_vent_flag <- "Y"
  noninvasive_ventilation <- noninvasive_ventilation %>%
    select("discharge_id" = `Discharge ID`, noninvasive_vent_flag)
  noninvasive_ventilation <- noninvasive_ventilation[!duplicated(noninvasive_ventilation$discharge_id), ]
  temp_table <- left_join(bronchiolits_table, noninvasive_ventilation, by = "discharge_id")
  temp_table <- left_join(temp_table, invasive_ventilation, by = "discharge_id")
  temp_table$invasive_vent_flag <- replace_na(temp_table$invasive_vent_flag, "N")
  temp_table$invasive_vent_flag <- as.factor(temp_table$invasive_vent_flag)
  temp_table$noninvasive_vent_flag <- replace_na(temp_table$noninvasive_vent_flag, "N")
  temp_table$noninvasive_vent_flag <- as.factor(temp_table$noninvasive_vent_flag)
  temp_table <- temp_table %>% mutate(invasive_and_noninvasive_vent_flag = if_else(noninvasive_vent_flag == "Y" & invasive_vent_flag == "Y", "Y", "N"))
  temp_table$invasive_and_noninvasive_vent_flag <- as.factor(temp_table$invasive_and_noninvasive_vent_flag)
  temp_table <- temp_table %>% mutate(highest_vent_support = case_when(
    invasive_vent_flag == "Y" ~ "invasive",
    noninvasive_vent_flag == "Y" & invasive_vent_flag == "N" ~ "noninvasive",
    noninvasive_vent_flag == "N" & invasive_vent_flag == "N" ~ "none"
  ))
  temp_table$highest_vent_support <- factor(temp_table$highest_vent_support, levels = c("none", "noninvasive", "invasive"))
  cat("The following information applies to:", bronchiolits_table_name, "\n")
  cat("There are", nrow(temp_table), "admissions.\n")
  cat("There are", nrow(subset(temp_table, invasive_vent_flag == "Y")), "admissions with invasive ventilation.\n")
  cat("There are", nrow(subset(temp_table, noninvasive_vent_flag == "Y")), "admissions with noninvasive ventilation.\n")
  cat("There are", nrow(subset(temp_table, invasive_and_noninvasive_vent_flag == "Y")), "admissions with both invasive and noninvasive ventilation.\n")
  cat("There are", nrow(subset(temp_table, highest_vent_support == "invasive")), "admissions with invasive ventilation as the highest level of support (should match the number with invasive ventilation).\n")
  cat("There are", nrow(subset(temp_table, highest_vent_support == "noninvasive")), "admissions with noninvasive ventilation as the highest level of support (should be the number with noninvasive ventilation minus the number with both invasive and noninvasive).\n")
  cat("There are", nrow(subset(temp_table, highest_vent_support == "none")), "admissions with no ventilatory support.\n\n\n")
  return(temp_table)
}

all_bronchiolitis_diagnoses <- reading_ventilation_codes_function("Bronchiolitis_PHIS_Reports/All_Bronchiolitis_Invasive_Ventilation_Codes.csv", "Bronchiolitis_PHIS_Reports/All_Bronchiolitis_Noninvasive_Ventilation_Codes.csv", all_bronchiolitis_diagnoses, "All Bronchiolitis Diagnoses Table")

primary_bronchiolitis_diagnoses <- reading_ventilation_codes_function("Bronchiolitis_PHIS_Reports/Bronchiolitis_Primary_Diagnosis_Invasive_Ventilation_Codes.csv", "Bronchiolitis_PHIS_Reports/Bronchiolitis_Primary_Diagnosis_Noninvasive_Ventilation_Codes.csv", primary_bronchiolitis_diagnoses, "Primary Bronchiolitis Diagnoses Table")

apr_drg_bronchiolitis <- reading_ventilation_codes_function("Bronchiolitis_PHIS_Reports/Bronchiolitis_APR-DRG_v32_Invasive_Ventilation_Codes.csv", "Bronchiolitis_PHIS_Reports/Bronchiolitis_APR-DRG_v32_Noninvasive_Ventilation_Codes.csv", apr_drg_bronchiolitis, "APR-DRG v32 Bronchiolitis Diagnoses Table")

rm(reading_ventilation_codes_function)
```

```{r generate a total vent support factor column}
total_vent_function <- function(bronchiolitis_table) {
  bronchiolitis_table <- bronchiolitis_table %>% mutate(total_vent_support = case_when(
    invasive_vent_flag == "Y" & noninvasive_vent_flag == "Y" ~ "both",
    invasive_vent_flag == "Y" & noninvasive_vent_flag == "N" ~ "invasive",
    noninvasive_vent_flag == "Y" & invasive_vent_flag == "N" ~ "noninvasive",
    noninvasive_vent_flag == "N" & invasive_vent_flag == "N" ~ "none"
  ))
  bronchiolitis_table$total_vent_support <- as.factor(bronchiolitis_table$total_vent_support)
  return(bronchiolitis_table)
}

all_bronchiolitis_diagnoses <- total_vent_function(all_bronchiolitis_diagnoses)
primary_bronchiolitis_diagnoses <- total_vent_function(primary_bronchiolitis_diagnoses)
apr_drg_bronchiolitis <- total_vent_function(apr_drg_bronchiolitis)

rm(total_vent_function)
```

```{r generate an invasive vent numeric column}
vent_numeric_function <- function(bronchiolitis_table) {
  bronchiolitis_table <- bronchiolitis_table %>%
    mutate(invasive_vent_numeric = case_when(
      invasive_vent_flag == "Y" ~ 1,
      invasive_vent_flag == "N" ~ 0
    ))

  bronchiolitis_table <- bronchiolitis_table %>%
    mutate(noninvasive_vent_numeric = case_when(
      noninvasive_vent_flag == "Y" ~ 1,
      noninvasive_vent_flag == "N" ~ 0
    ))

  return(bronchiolitis_table)
}

all_bronchiolitis_diagnoses <- vent_numeric_function(all_bronchiolitis_diagnoses)
primary_bronchiolitis_diagnoses <- vent_numeric_function(primary_bronchiolitis_diagnoses)
apr_drg_bronchiolitis <- vent_numeric_function(apr_drg_bronchiolitis)
rm(vent_numeric_function)
```

```{r restrict cohorts to hospitals with 10 years of data}

years_of_data_function <- function(bronchiolitis_table) {
  years_of_data <- bronchiolitis_table %>%
    group_by(hospital_number) %>%
    dplyr::summarise(
      "years" = max(discharge_year) - min(discharge_year)
    )
  years_of_data <- subset(years_of_data, years_of_data$years == 9) # this is 9 and not 10 because 2019-2010 = 9
  temp <- subset(bronchiolitis_table, hospital_number %in% years_of_data$hospital_number) # select for hospitals with 10 years of data (max-min=9)
  return(temp)
}

all_bronchiolitis_diagnoses <- years_of_data_function(all_bronchiolitis_diagnoses)
primary_bronchiolitis_diagnoses <- years_of_data_function(primary_bronchiolitis_diagnoses)
apr_drg_bronchiolitis <- years_of_data_function(apr_drg_bronchiolitis)

rm(years_of_data_function)
```

```{r confirm that there are no duplicate discharge_id values}

ifelse(nrow(subset(all_bronchiolitis_diagnoses, duplicated(all_bronchiolitis_diagnoses$discharge_id))) == 0, paste("GOOD TO GO: There are no duplicated discharge IDs within the all bronchiolitis spreadsheet."), paste("WARNING: There are duplicate discharge IDs within the all bronchiolitis spreadsheet."))

ifelse(nrow(subset(primary_bronchiolitis_diagnoses, duplicated(primary_bronchiolitis_diagnoses$discharge_id))) == 0, paste("GOOD TO GO: There are no duplicated discharge IDs within the primary bronchiolitis diagnosis spreadsheet."), paste("WARNING: There are duplicate discharge IDs within the primary bronchiolitis diagnosis spreadsheet."))

ifelse(nrow(subset(apr_drg_bronchiolitis, duplicated(apr_drg_bronchiolitis$discharge_id))) == 0, paste("GOOD TO GO: There are no duplicated discharge IDs within the APR-DRG v32 bronchiolitis spreadsheet."), paste("WARNING: There are duplicate discharge IDs within the APR-DRG v32 bronchiolitis spreadsheet."))

```

```{r develop cohorts with and without ccc}
all_bronchiolitis_diagnoses_no_ccc <- subset(all_bronchiolitis_diagnoses, complex_chronic_condition_flag == "N")
all_bronchiolitis_diagnoses_yes_ccc <- subset(all_bronchiolitis_diagnoses, complex_chronic_condition_flag == "Y")

primary_bronchiolitis_diagnoses_no_ccc <- subset(primary_bronchiolitis_diagnoses, complex_chronic_condition_flag == "N")
primary_bronchiolitis_diagnoses_yes_ccc <- subset(primary_bronchiolitis_diagnoses, complex_chronic_condition_flag == "Y")
```

```{r develop_pittsburgh_primary_cohort}
pittsburgh_primary_bronchiolitis_diagnoses <- filter(primary_bronchiolitis_diagnoses, hospital_city == "Pittsburgh")
```

```{r generate table 1 or demographics table}

# complex chronic condition flag definitions can be found at: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4134331/ associated ICD codes can be found in additional file 5

# note that the mechanical ventilation flag being used here is that from PHIS, which is DIFFERENT from that used by Fujiogi M, Goto T, Yasunaga H, et al. Trends in Bronchiolitis Hospitalizations in the United States: 2000-2016. Pediatrics. 2019.

demographics_table_function <- function(cohort_table, cohort_name, cohort_discharge_id_column) {
  demographics_table <- cohort_table %>% summarise(
    "number of unique admissions" = n_distinct(discharge_id),
    "number of unique patients" = n_distinct(medical_record_number),
    "median age in months (IQR)" = median(admit_age_in_months),
    "25% age in months" = quantile(admit_age_in_months, probs = c(0.25)),
    "75% age in months" = quantile(admit_age_in_months, probs = c(0.75)),
    "male" = sum(gender_title == "Male"),
    "white" = sum(race_white == "Y"),
    "black" = sum(race_black == "Y"),
    "asian" = sum(race_asian == "Y"),
    "american indian" = sum(race_american_indian == "Y"),
    "pacific islander" = sum(race_pacific_islander == "Y"),
    "other race" = sum(race_other == "Y"),
    "hispanic" = sum(ethnicity_title == "Hispanic or Latino"),
    "commercial insurance" = sum(primary_source_of_payment_simplified == "Commercial"),
    "government insurance" = sum(primary_source_of_payment_simplified == "Government"),
    "other insurance" = sum(primary_source_of_payment_simplified == "Other"),
    "complex chronic condition" = sum(complex_chronic_condition_flag == "Y"),
    "cardiovascular condition" = sum(cardiovascular_flag == "Y"),
    "gastrointestinal condition" = sum(gastrointestinal_flag == "Y"),
    "hematologic or immunologic condition" = sum(hematologic_or_immunologic_flag == "Y"),
    "malignancy" = sum(malignancy_flag == "Y"),
    "metabolic condition" = sum(metabolic_flag == "Y"),
    "neurologic condition" = sum(neurologic_and_neuromuscular_flag == "Y"),
    "genetic condition" = sum(other_congenital_or_genetic_defect_flag == "Y"),
    "premature or neonatal condition" = sum(premature_and_neonatal_flag == "Y"),
    "renal condition" = sum(renal_and_urologic_flag == "Y"),
    "respiratory condition" = sum(respiratory_flag == "Y"),
    "technology dependent" = sum(technology_dependent_flag == "Y"),
    "transplant recipient" = sum(transplant_flag == "Y"),
    "mental health disorder" = sum(mental_health_disorder_flag == "Y"),
    "secondary mental health disorder" = sum(secondary_dx_mental_health_disorder_flag == "Y"),
    "median hospital length of stay (IQR)" = median(length_of_stay),
    "25% hospital length of stay" = quantile(length_of_stay, probs = c(0.25)),
    "75% hospital length of stay" = quantile(length_of_stay, probs = c(0.75)),
    "admitted to icu" = sum(icu_flag == "Y"),
    "highest support of invasive ventilation" = sum(highest_vent_support == "invasive"),
    "highest support of noninvasive ventilation" = sum(highest_vent_support == "noninvasive"),
    "no ventilatory support" = sum(highest_vent_support == "none"),
    "received ecmo" = sum(ecmo_flag == "Y"),
    "median cost (IQR)" = median(estimated_cost, na.rm = TRUE),
    "25% cost" = quantile(estimated_cost, probs = c(0.25), na.rm = TRUE),
    "75% cost" = quantile(estimated_cost, probs = c(0.75), na.rm = TRUE),
    "median abstracted charge (IQR)" = median(abstract_based_charges, na.rm = TRUE),
    "25% abstracted charge" = quantile(abstract_based_charges, probs = c(0.25), na.rm = TRUE),
    "75% abstracted charge" = quantile(abstract_based_charges, probs = c(0.75), na.rm = TRUE),
    "median cms adjusted cost (IQR)" = median(adj_estimated_cost, na.rm = TRUE),
    "25% cms adjusted cost" = quantile(adj_estimated_cost, probs = c(0.25), na.rm = TRUE),
    "75% cms adjusted cost" = quantile(adj_estimated_cost, probs = c(0.75), na.rm = TRUE),
    "median cms adjusted abstracted charge (IQR)" = median(adj_abstract_based_charges, na.rm = TRUE),
    "25% cms adjusted abstracted charge" = quantile(adj_abstract_based_charges, probs = c(0.25), na.rm = TRUE),
    "75% cms adjusted abstracted charge" = quantile(adj_abstract_based_charges, probs = c(0.75), na.rm = TRUE),
    "survived to discharge" = sum(discharge_mortality_flag == "N")
  )
  demographics_table <- as_tibble(cbind(variable = names(demographics_table), t(demographics_table)), .name_repair = c("minimal"))
  colnames(demographics_table) <- c("Variable", "cohort_n")
  demographics_table$Variable <- as.character(demographics_table$Variable)
  demographics_table$cohort_n <- as.numeric(demographics_table$cohort_n)
  demographics_table$cohort_percent <- round((demographics_table$cohort_n / n_distinct(cohort_discharge_id_column) * 100), digits = 1)
  demographics_table <- rbind(c("Variable", cohort_name, ""), demographics_table) # add headers for hux
  demographics_table$cohort_percent <- gsub("$", "\\%", demographics_table$cohort_percent) # add percents to end of col3
  demographics_table[4, 3] <- paste(demographics_table[[5, 2]], demographics_table[[6, 2]], sep = "-") # add IQR for ages
  demographics_table <- demographics_table[-c(5, 6), ] # remove 25% and 75% rows
  demographics_table[31, 3] <- paste(demographics_table[[32, 2]], demographics_table[[33, 2]], sep = "-") # add IQR for LOS
  demographics_table <- demographics_table[-c(32, 33), ] # remove 25% and 75% rows
  demographics_table[37, 3] <- paste(demographics_table[[38, 2]], demographics_table[[39, 2]], sep = "-") # add IQR for cost
  demographics_table <- demographics_table[-c(38, 39), ] # remove 25% and 75% rows
  demographics_table[38, 3] <- paste(demographics_table[[39, 2]], demographics_table[[40, 2]], sep = "-") # add IQR adj cost
  demographics_table <- demographics_table[-c(39, 40), ] # remove 25% and 75% rows
  demographics_table[39, 3] <- paste(demographics_table[[40, 2]], demographics_table[[41, 2]], sep = "-") # add IQR charge
  demographics_table <- demographics_table[-c(40, 41), ] # remove 25% and 75% rows
  demographics_table[40, 3] <- paste(demographics_table[[41, 2]], demographics_table[[42, 2]], sep = "-") # add IQR adj chrg
  demographics_table <- demographics_table[-c(41, 42), ] # remove 25% and 75% rows
  demographics_table <- demographics_table[-c(29, 30), ] # remove mental health disorders (clinically meaningless)
  demographics_table$cohort_percent <- gsub("^", "\\(", demographics_table$cohort_percent) # add parenthesis to beginng of col3
  demographics_table$cohort_percent <- gsub("$", "\\)", demographics_table$cohort_percent) # add parenthesis to end of col3
  demographics_table[3, 3] <- "" # remove percents from unique patients
  demographics_table[1, 3] <- "" # remove header for third column
  demographics_table <- unite(demographics_table, Values, c(cohort_n, cohort_percent), sep = " ")
  demographics_table$Values <- gsub(" $", "", demographics_table$Values) # remove terminal spaces from merging
  return(demographics_table)
}

demographics_all_bronchiolitis <- demographics_table_function(all_bronchiolitis_diagnoses, "Sensitivity Analysis: All Bronchiolitis Diagnoses", all_bronchiolitis_diagnoses$discharge_id)

demographics_all_bronchiolitis_no_ccc <- demographics_table_function(all_bronchiolitis_diagnoses_no_ccc, "All Bronchiolitis Diagnoses Without CCC", all_bronchiolitis_diagnoses_no_ccc$discharge_id)

demographics_all_bronchiolitis_yes_ccc <- demographics_table_function(all_bronchiolitis_diagnoses_yes_ccc, "All Bronchiolitis Diagnoses With CCC", all_bronchiolitis_diagnoses_yes_ccc$discharge_id)

demographics_primary_bronchiolitis_diagnoses <- demographics_table_function(primary_bronchiolitis_diagnoses, "Main Analysis: Primary Bronchiolitis Diagnoses", primary_bronchiolitis_diagnoses$discharge_id)

demographics_primary_bronchiolitis_diagnoses_no_ccc <- demographics_table_function(primary_bronchiolitis_diagnoses_no_ccc, "Bronchiolitis Primary Diagnoses Without CCC", primary_bronchiolitis_diagnoses_no_ccc$discharge_id)

demographics_primary_bronchiolitis_diagnoses_yes_ccc <- demographics_table_function(primary_bronchiolitis_diagnoses_yes_ccc, "Bronchiolitis Primary Diagnoses With CCC", primary_bronchiolitis_diagnoses_yes_ccc$discharge_id)

demographics_apr_drg_bronchiolitis <- demographics_table_function(apr_drg_bronchiolitis, "Sensitivity Analysis: APR-DRG v32 Bronchiolitis", apr_drg_bronchiolitis$discharge_id)

demographics_pittsburgh_primary_bronchiolitis <- demographics_table_function(pittsburgh_primary_bronchiolitis_diagnoses, "Nested Sub-Analysis: Single-Center Primary Bronchiolitis Diagnoses", pittsburgh_primary_bronchiolitis_diagnoses$discharge_id)

rm(demographics_table_function)

demographics_combined <- left_join(demographics_primary_bronchiolitis_diagnoses, demographics_all_bronchiolitis, by = "Variable")
demographics_combined <- left_join(demographics_combined, demographics_apr_drg_bronchiolitis, by = "Variable")
demographics_combined <- left_join(demographics_combined, demographics_pittsburgh_primary_bronchiolitis, by = "Variable")

rm(demographics_all_bronchiolitis, demographics_primary_bronchiolitis_diagnoses, demographics_apr_drg_bronchiolitis, demographics_all_bronchiolitis_no_ccc, demographics_all_bronchiolitis_yes_ccc, demographics_primary_bronchiolitis_diagnoses_no_ccc, demographics_primary_bronchiolitis_diagnoses_yes_ccc, demographics_pittsburgh_primary_bronchiolitis)
```

# Demographics


Here are the demographics for patients entered into PHIS with diagnostic codes of viral bronchiolitis.

Patients in the "All Bronchiolitis Diagnoses" cohort have ICD9/ICD10 codes for viral bronchiolitis as any diagnosis associated with that admission. Patients in the "Primary Bronchiolitis Diagnoses" cohort have a primary admission diagnosis of viral bronchiolitis. These cohorts are then further subdivided into patients with and without complex chronic conditions (CCC). The last column is the All Patient Refined Diagnosis Group, version 32 (APR-DRG v32) for viral bronchiolitis. These patients are selected by a proprietary algorithm developed by 3M.

## Number of Hospitals

```{r number_of_hospitals, reusults = "markdown"}
cat("The number of hospitals in the cohort was:

    ")

all_bronchiolitis_diagnoses %>% group_by(hospital_city) %>%
  summarize(number_of_patients = n()) %>% nrow()
```


## Demographics Table

```{r generate demographics huxtable, results="hold"}
# Generate Huxtable
library(huxtable)
ht <- hux(demographics_combined)
caption(ht) <- "Table 1: Cohort Demographics"
right_padding(ht) <- 10 # line up numbers
left_padding(ht) <- 10 # line up numbers
ht <- theme_plain(ht)
detach("package:huxtable", unload = TRUE)
rm(ht)

# Show demographics table without the spurious row needed for huxtable formatting

library(kableExtra)
colnames(demographics_combined) <- demographics_combined[1, ]

knitr::kable(demographics_combined[-1, ], caption = "Table 1: Cohort Demographics") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"), fixed_thead = F) %>%
  pack_rows("n", 1, 2) %>%
  pack_rows("Age", 3, 3) %>%
  pack_rows("Sex", 4, 4) %>%
  pack_rows("Race", 5, 10) %>%
  pack_rows("Ethnicity", 11, 11) %>%
  pack_rows("Insurance", 12, 14) %>%
  pack_rows("Complex Chronic Conditions", 15, 27) %>%
  pack_rows("Admission Characteristics", 28, 33) %>%
  pack_rows("Cost of Care", 34, 37) %>%
  pack_rows("Survival", 38, 38)
```

# Incidence

```{r load_all_hospital_admissions_file}
# import data file with all PHIS hospital admissions, ICU admissions, and ECMO cases for 2010-2019
all_hospital_admissions <- read_csv("Bronchiolitis_PHIS_Reports//All_Hospital_Admissions_and_ICU_Admissions_Under_2.csv", col_types = cols(
  `Hospital Number` = col_double(),
  `Hospital City` = col_factor(),
  `Discharge Year` = col_double(),
  `Number Of Patients` = col_number(),
  `Number Of Cases` = col_number(),
  `ICU Count` = col_number(),
  `Mechanical Vent Count` = col_number(),
  `ECMO Count` = col_double()
))

names(all_hospital_admissions) <- names(all_hospital_admissions) %>%
  stringr::str_replace_all("\\s", "_") %>%
  tolower()

# restrict to admissions from hospitals in the main analysis

all_hospital_admissions <- all_bronchiolitis_diagnoses %>%
  select(hospital_city) %>%
  distinct(hospital_city) %>%
  left_join(., all_hospital_admissions, by = "hospital_city")

# generate pittsburgh all hospital admissions table
pittburgh_all_hospital_admissions <- all_hospital_admissions %>%
  filter(hospital_city == "Pittsburgh")
```

## Incidence and ICU Admission Tabular Data and Regression {.tabset .tabset_fade}

```{r show_yearly_admission_table and linear regression}
yearly_table_function <- function(bronchiolitis_table) {
  yearly_bronchiolitis_admissions <- bronchiolitis_table %>%
    group_by(discharge_year) %>%
    summarise(
      "bronchiolitis_admissions" = n_distinct(discharge_id),
      "bronchiolitis_icu_admissions" = sum(icu_flag == "Y")
    )

  hospital_vs_bronchiolitis_admissions <- all_hospital_admissions %>%
    group_by(discharge_year) %>%
    summarize(
      "hospital_admissions" = sum(number_of_cases),
      "hospital_icu_admissions" = sum(icu_count),
    )
  
  percent_bronchiolitis_table <- left_join(yearly_bronchiolitis_admissions, hospital_vs_bronchiolitis_admissions, by = "discharge_year") %>%
    mutate(percent_bronchiolitis_hospital_admissions = round(bronchiolitis_admissions/hospital_admissions*100,1)) %>%
    mutate(percent_bronchiolitis_icu_admissions = round(bronchiolitis_icu_admissions/hospital_icu_admissions*100,1))
  
  hospital_admissions_linear <- summary(lm(percent_bronchiolitis_hospital_admissions~discharge_year, data = percent_bronchiolitis_table))
  
  icu_admissions_linear <- summary(lm(percent_bronchiolitis_icu_admissions~discharge_year, data = percent_bronchiolitis_table))
  
  return(list(percent_bronchiolitis_table, hospital_admissions_linear, icu_admissions_linear))
}

primary_bronchiolitis_yearly_table <- yearly_table_function(primary_bronchiolitis_diagnoses)
rm(yearly_table_function)
```

### Primary Bronchiolitis Yearly Data Table

```{r primary_bronchiolitis_yearly_table, results = "markdown"}
as.data.frame(primary_bronchiolitis_yearly_table[[1]])
```

### Linear Regression For Hospital Admissions

```{r show_hospital_admission_regression, results="markdown"}
primary_bronchiolitis_yearly_table[[2]]
```

### Linear Regression for ICU Admision

```{r show_icu_admission_regression, results="markdown"}
primary_bronchiolitis_yearly_table[[3]]
rm(primary_bronchiolitis_yearly_table)
```

## Percentage Admitted To The ICU: Figure 1

```{r graph percent admitted to ICU by year, results = "hold", out.width="33%"}

yearly_graph_function <- function(bronchiolitis_table, graph_name) {
  yearly_bronchiolitis_mortality <- bronchiolitis_table %>%
    group_by(discharge_year) %>%
    summarise(
      "admissions" = n_distinct(discharge_id),
      "patients" = n_distinct(medical_record_number),
      "icu_admissions" = sum(icu_flag == "Y"),
      "number_dead" = sum(discharge_mortality_flag == "Y"),
      "proportion_icu" = sum(icu_flag == "Y") / n_distinct(discharge_id)
    )

  linear_icu_over_time <- lm(proportion_icu ~ discharge_year, data = yearly_bronchiolitis_mortality)
  temp_delta <- round(summary(linear_icu_over_time)$coefficients[2, 1] * 100, 3)

  yearly_plot <- ggplot(data = yearly_bronchiolitis_mortality, mapping = aes(x = discharge_year, y = proportion_icu * 100)) +
    geom_bar(stat = "identity", fill = "gray80") +
    geom_text(aes(label = round(proportion_icu * 100, digits = 1)), color = "black", position = position_stack(vjust = 0.5), size = 3) +
    ylab("% of Bronchiolitis Admissions Admitted to ICU") +
    scale_x_continuous(name = "Discharge Year", breaks = c(2010:2019)) +
    theme_bw() +
    labs(title = graph_name) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5)) +
    theme(plot.caption = element_text(hjust = 0.5))+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

  return(yearly_plot)
}

primary_bronchiolitis_icu_yearly_graph <- yearly_graph_function(primary_bronchiolitis_diagnoses, "Primary Bronchiolitis Diagnoses")

rm(yearly_graph_function)

hospital_admission_icu_function <- function(hospital_admission_table, graph_name) {
  temp_table <- hospital_admission_table %>%
    ungroup() %>%
    group_by(discharge_year) %>%
    summarise(
      n_admissions = sum(number_of_cases),
      n_icu_admissions = sum(icu_count),
      proportion_icu = sum(icu_count) / sum(number_of_cases),
      .groups = "drop_last"
    )

  linear_icu_over_time <- lm(proportion_icu ~ discharge_year, data = temp_table)
  temp_delta <- round(summary(linear_icu_over_time)$coefficients[2, 1] * 100, 3)

  yearly_plot <- ggplot(data = temp_table, mapping = aes(x = discharge_year, y = proportion_icu * 100)) +
    geom_bar(stat = "identity", fill = "gray80") +
    geom_text(aes(label = round(proportion_icu * 100, digits = 1)), color = "black", position = position_stack(vjust = 0.5), size = 3) +
    ylab("% of Hospital Admissions Admitted to ICU") +
    scale_x_continuous(name = "Discharge Year", breaks = c(2010:2019)) +
    theme_bw() +
    labs(title = graph_name) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5)) +
    theme(plot.caption = element_text(hjust = 0.5))+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

  return(yearly_plot)
}

hospital_icu_yearly_graph <- hospital_admission_icu_function(all_hospital_admissions, "All Hospital Admissions Under 2 Years")

```

```{r figure_1, results="markdown"}
library(cowplot)
cowplot::plot_grid(primary_bronchiolitis_icu_yearly_graph, hospital_icu_yearly_graph, labels = "AUTO")
ggsave("Manuscript_Figures//Figure_1.tiff")
```

# Ventilation: Figure 2

## Ventilation Trends

```{r rates of invasive and noninvasive ventilation by year and hospital}
library(lubridate)

yearly_graph_function <- function(bronchiolitis_table, graph_name) {
  yearly_bronchiolitis_ventilation <- bronchiolitis_table %>%
    group_by(discharge_year) %>%
    summarise(
      "admissions" = n_distinct(discharge_id),
      "patients" = n_distinct(medical_record_number),
      "icu_admissions" = sum(icu_flag == "Y"),
      "number_no_vent_support" = sum(highest_vent_support == "none"),
      "number_noninvasive_vent_support" = sum(highest_vent_support == "noninvasive"),
      "number_invasive_vent_support" = sum(highest_vent_support == "invasive"),
      "proportion_no_vent_support" = sum(highest_vent_support == "none") / n_distinct(discharge_id),
      "proportion_noninvasive_vent_support" = sum(highest_vent_support == "noninvasive") / n_distinct(discharge_id),
      "proportion_invasive_vent_support" = sum(highest_vent_support == "invasive") / n_distinct(discharge_id),
      "number_ecmo_admissions" = sum(ecmo_flag == "Y"),
      "proportion_ecmo_admissions" = sum(ecmo_flag == "Y") / n_distinct(discharge_id)
    )

  linear_invasive_vent_over_time <- lm(proportion_invasive_vent_support ~ discharge_year, data = yearly_bronchiolitis_ventilation)

  linear_noninvasive_vent_over_time <- lm(proportion_noninvasive_vent_support ~ discharge_year, data = yearly_bronchiolitis_ventilation)

  pivot_table <- yearly_bronchiolitis_ventilation %>% pivot_longer(cols = c(proportion_noninvasive_vent_support, proportion_invasive_vent_support))
  pivot_table$name <- factor(pivot_table$name, levels = c("proportion_noninvasive_vent_support", "proportion_invasive_vent_support"))

  yearly_plot <- ggplot(data = pivot_table, mapping = aes(x = discharge_year, y = value * 100, fill = name)) +
    geom_bar(position = "stack", stat = "identity") +
    geom_text(aes(label = round(value * 100, digits = 1)), color = "black", position = position_stack(vjust = 0.5), size = 2) +
    ylab("%") +
    scale_x_continuous(name = "Discharge Year", breaks = c(2010:2019)) +
    theme_bw() +
    labs(title = graph_name) +
    scale_fill_manual(values = c("gray70", "gray60"), name = "Highest Ventilator Support", labels = c("Non-invasive", "Invasive")) +
    theme(plot.title = element_text(hjust = 0.5, size = 12)) +
    theme(plot.subtitle = element_text(hjust = 0.5)) +
    theme(plot.caption = element_text(hjust = 0.5)) +
    theme(legend.position = "right")

  return(yearly_plot)
}

year_primary <- yearly_graph_function(primary_bronchiolitis_diagnoses, "Ventilatory Support Among All Admissions")

rm(yearly_graph_function)

```

```{r ventilation_in_icu_admissions}

icu_ventilation_function <- function(bronchiolitis_table, graph_name) {
  temp_table <- bronchiolitis_table %>%
    filter(icu_flag == "Y") %>%
    mutate(highest_none_numeric = ifelse(highest_vent_support == "none", 1, 0)) %>%
    mutate(highest_noninvasive_numeric = ifelse(highest_vent_support == "noninvasive", 1, 0)) %>%
    mutate(highest_invasive_numeric = ifelse(highest_vent_support == "invasive", 1, 0)) %>%
    group_by(discharge_year) %>%
    summarize(
      none = sum(highest_none_numeric),
      noninvasive = sum(highest_noninvasive_numeric),
      invasive = sum(highest_invasive_numeric),
      .groups = "drop_last"
    )

  temp_none_delta <- summary(lm(none ~ discharge_year, data = temp_table))$coefficients[2, 1]
  temp_none_p <- summary(lm(none ~ discharge_year, data = temp_table))$coefficients[2, 4]

  temp_noninvasive_delta <- summary(lm(noninvasive ~ discharge_year, data = temp_table))$coefficients[2, 1]
  temp_noninvasive_p <- summary(lm(noninvasive ~ discharge_year, data = temp_table))$coefficients[2, 4]

  temp_invasive_delta <- summary(lm(invasive ~ discharge_year, data = temp_table))$coefficients[2, 1]
  temp_invasive_p <- summary(lm(invasive ~ discharge_year, data = temp_table))$coefficients[2, 4]

  temp_table %>%
    pivot_longer(cols = c(none, noninvasive, invasive), values_to = "n", names_to = "highest_vent_support") %>%
    mutate(highest_vent_support = factor(highest_vent_support, levels = c("invasive", "noninvasive", "none"))) %>%
    ggplot(aes(x = factor(discharge_year), y = n, fill = highest_vent_support)) +
    geom_col(position = "stack") +
    scale_fill_grey(start = 0.6, end = 0.8, name = "Highest Ventilator Support", labels = c("Invasive", "Non-invasive", "None")) +
    geom_text(aes(label = n, x = factor(discharge_year), y = n, group = highest_vent_support), position = position_stack(vjust = 0.5), size = 2) +
    theme_bw() +
    labs(title = "Ventilatory Support Among Patients Admitted to the ICU") +
    xlab("Discharge Year") +
    ylab("N") +
    theme(plot.subtitle = element_text(hjust = 0.5), plot.title = element_text(hjust = 0.5, size = 12))
}

icu_ventilation_number_primary <- icu_ventilation_function(primary_bronchiolitis_diagnoses, "Primary Bronchiolitis Diagnoses")

rm(icu_ventilation_function)

```

```{r figure_2, results = "markdown"}
cowplot::plot_grid(year_primary, icu_ventilation_number_primary, nrow = 2, labels = "AUTO")
ggsave("Manuscript_Figures//Figure_2.tiff")
```

```{r clean_up_figure_2}
rm(year_primary, icu_ventilation_number_primary)
```

# Cost

```{r load files with BEA GDP and CMS healthcare expenditure files }

# GDP tables can be found at: https://apps.bea.gov/iTable/iTable.cfm?reqid=19&step=2#reqid=19&step=2&isuri=1&1921=survey
# GDP is: Table 1.1.5. Gross Domestic Product

# NHE tables can be found at: https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/NationalHealthExpendData/NationalHealthAccountsHistorical
# NHE table of interest is: Table 01 National Health Expenditures; Aggregate and Per Capita Amounts

# Please note that the 2019 NHE data uses the PROJECTED value from CMS.gov, as the actual value was not available as of June 10, 2020. The projectional table can be found at: https://www.cms.gov/Research-Statistics-Data-and-Systems/Statistics-Trends-and-Reports/NationalHealthExpendData/NationalHealthAccountsProjected

bea_gdp <- read_csv("Bronchiolitis_GDP_Reports//bea_gdp_annual_report.csv")
bea_gdp <- filter(bea_gdp, X1 == "Gross domestic product") %>%
  pivot_longer(cols = c(`2010`, `2011`, `2012`, `2013`, `2014`, `2015`, `2016`, `2017`, `2018`, `2019`), names_to = "discharge_year", values_to = "bea_gdp_in_billions") %>%
  select(discharge_year, bea_gdp_in_billions) %>%
  mutate(dollars_2010 = bea_gdp_in_billions / bea_gdp_in_billions[1]) %>%
  mutate(discharge_year = as.numeric(discharge_year))

cms_nhe <- readxl::read_xlsx("Bronchiolitis_GDP_Reports//NHE_Summary.xlsx")

nhe_as_gdp_percent <- pivot_longer(cms_nhe, cols = c(2:11)) %>%
  filter(Year == "NHE as GDP %") %>%
  select("discharge_year" = name, "nhe_as_gdp_percent" = value) %>%
  mutate(discharge_year = as.numeric(discharge_year))
nhe_as_gdp_percent$dollars_2010 <- nhe_as_gdp_percent$nhe_as_gdp_percent / nhe_as_gdp_percent$nhe_as_gdp_percent[1]

nhe_per_capita <- pivot_longer(cms_nhe, cols = c(2:11)) %>%
  filter(Year == "NHE in Billions" | Year == "US Population in Millions") %>%
  pivot_wider(id_cols = name, values_from = value, names_from = Year) %>%
  select("discharge_year" = name, "nhe_in_billions" = `NHE in Billions`, "us_population_in_millions" = `US Population in Millions`) %>%
  mutate(discharge_year = as.numeric(discharge_year)) %>%
  mutate(nhe_in_millions = nhe_in_billions * 1000) %>%
  mutate(nhe_per_capita_in_dollars = nhe_in_millions / us_population_in_millions) %>%
  mutate(dollars_2010 = nhe_per_capita_in_dollars / nhe_per_capita_in_dollars[1])

cms_nhe <- pivot_longer(cms_nhe, cols = c(2:11)) %>%
  filter(Year == "NHE in Billions") %>%
  select("discharge_year" = name, "cms_nhe" = value) %>%
  mutate(discharge_year = as.numeric(discharge_year))
```

## Cost Tabular Ouputs and Regression  {.tabset .tabset-fade}

```{r tabular output of cost of care, results = "markdown"}
yearly_table_function <- function(bronchiolitis_table, inflation_table, graph_name, graph_notes) {
  yearly_table <- bronchiolitis_table %>%
    group_by(discharge_year) %>%
    group_by(total_vent_support, add = TRUE) %>%
    summarize(
      "admissions" = n_distinct(discharge_id),
      "patients" = n_distinct(medical_record_number),
      "icu_admissions" = sum(icu_flag == "Y"),
      "ecmo_admissions" = sum(ecmo_flag == "Y"),
      "total_adjusted_charge" = sum(adj_abstract_based_charges, na.rm = TRUE),
      "total_adjusted_cost" = sum(adj_estimated_cost, na.rm = TRUE)
    )

  yearly_table_2 <- bronchiolitis_table %>%
    ungroup() %>%
    group_by(discharge_year) %>%
    summarize(
      "yearly_cost" = sum(adj_estimated_cost, na.rm = TRUE),
      "yearly_admissions" = n_distinct(discharge_id),
      "yearly_median_cost" = median(adj_estimated_cost, na.rm = TRUE)
    )

  yearly_table <- left_join(yearly_table, yearly_table_2, by = "discharge_year")

  yearly_table$yearly_cost[c(seq(2, 38, by = 4), seq(3, 39, by = 4), seq(4, 40, by = 4))] <- NA
  yearly_table$yearly_median_cost[c(seq(2, 38, by = 4), seq(3, 39, by = 4), seq(4, 40, by = 4))] <- NA
  yearly_table$yearly_admissions[c(seq(2, 38, by = 4), seq(3, 39, by = 4), seq(4, 40, by = 4))] <- NA

  yearly_table <- left_join(yearly_table, inflation_table, by = "discharge_year") %>%
    mutate("total_inflation_adjusted_cost" = total_adjusted_cost / (dollars_2010) / 1000000) %>%
    mutate("total_inflation_adjusted_yearly_cost" = yearly_cost / (dollars_2010) / 1000000) %>%
    mutate("total_inflation_adjusted_yearly_median_cost" = yearly_median_cost / (dollars_2010))
  
  yearly_cost_regression <- summary(lm(total_inflation_adjusted_yearly_cost ~ discharge_year, data = yearly_table))
  
  return(list(yearly_table, yearly_cost_regression))
}

bea_gdp_annual_primary_table <- yearly_table_function(primary_bronchiolitis_diagnoses, bea_gdp)

rm(yearly_table_function)
```

### Yearly Cost Table

```{r show_yearly_cost_table, results="markdown"}
bea_gdp_annual_primary_table[[1]]
```

### Yearly Cost Regression

```{r show_yearly_cost_regression, results="markdown"}
bea_gdp_annual_primary_table[[2]]
rm(bea_gdp_annual_primary_table)
```

### Per Patient Cost Table

```{r per_patient_tabular}
cost_per_patient_function <- function(bronchiolitis_table, adjustment_table) {
  temp_adjustment_table <- adjustment_table %>% dplyr::select(discharge_year, dollars_2010)
  temp_table <- left_join(bronchiolitis_table, temp_adjustment_table, by = "discharge_year")
  temp_table <- temp_table %>% mutate(inflation_adjusted_cost = adj_estimated_cost / dollars_2010)
  
  temp_table <- temp_table %>% group_by(discharge_year) %>%
    summarize(
      median_cost = round(median(inflation_adjusted_cost, na.rm=TRUE),2)
    )
  
  temp_regression <- summary(lm(median_cost ~ discharge_year, data = temp_table))
  
  return(list(temp_table, temp_regression))
}
  
per_patient_bea_gdp_primary_table <- cost_per_patient_function(primary_bronchiolitis_diagnoses, bea_gdp)
```

```{r per_patient_cost_table,results="markdown"}
per_patient_bea_gdp_primary_table[[1]]
```
### Per Patient Cost Regression

```{r per_patient_cost_regression,results="markdown"}
per_patient_bea_gdp_primary_table[[2]]
rm(per_patient_bea_gdp_primary_table)
```

## Cost Graph: Figure 3

```{r analyze total cost by year adjusting for GDP}

yearly_graph_function <- function(bronchiolitis_table, inflation_table, graph_name, graph_notes) {
  yearly_table <- bronchiolitis_table %>%
    group_by(discharge_year) %>%
    group_by(total_vent_support, add = TRUE) %>%
    summarize(
      "admissions" = n_distinct(discharge_id),
      "patients" = n_distinct(medical_record_number),
      "icu_admissions" = sum(icu_flag == "Y"),
      "ecmo_admissions" = sum(ecmo_flag == "Y"),
      "total_adjusted_charge" = sum(adj_abstract_based_charges, na.rm = TRUE),
      "total_adjusted_cost" = sum(adj_estimated_cost, na.rm = TRUE)
    )

  yearly_table_2 <- bronchiolitis_table %>%
    ungroup() %>%
    group_by(discharge_year) %>%
    summarize(
      "yearly_cost" = sum(adj_estimated_cost, na.rm = TRUE),
      "yearly_admissions" = n_distinct(discharge_id),
      "yearly_median_cost" = median(adj_estimated_cost, na.rm = TRUE)
    )

  yearly_table <- left_join(yearly_table, yearly_table_2, by = "discharge_year")

  yearly_table$yearly_cost[c(seq(2, 38, by = 4), seq(3, 39, by = 4), seq(4, 40, by = 4))] <- NA
  yearly_table$yearly_median_cost[c(seq(2, 38, by = 4), seq(3, 39, by = 4), seq(4, 40, by = 4))] <- NA
  yearly_table$yearly_admissions[c(seq(2, 38, by = 4), seq(3, 39, by = 4), seq(4, 40, by = 4))] <- NA

  yearly_table <- left_join(yearly_table, inflation_table, by = "discharge_year") %>%
    mutate("total_inflation_adjusted_cost" = total_adjusted_cost / (dollars_2010) / 1000000) %>%
    mutate("total_inflation_adjusted_yearly_cost" = yearly_cost / (dollars_2010) / 1000000) %>%
    mutate("total_inflation_adjusted_yearly_median_cost" = yearly_median_cost / (dollars_2010))

  temp_los <- summary(lm(total_inflation_adjusted_yearly_cost ~ discharge_year, data = yearly_table))$coefficients[2, 1]
  temp_p <- summary(lm(total_inflation_adjusted_yearly_cost ~ discharge_year, data = yearly_table))$coefficients[2, 4]

  yearly_plot <- ggplot(data = yearly_table, mapping = aes(x = as.factor(discharge_year), y = total_inflation_adjusted_cost, fill = factor(total_vent_support, levels = c("both", "invasive", "noninvasive", "none")))) +
    geom_col() +
    scale_fill_grey(name = "Type of Ventilator Support", labels = c("Both", "Invasive", "Noninvasive", "None"), start = 0.5, end = 0.9) +
    theme_bw() +
    scale_y_continuous(name = "Annual Cost (millions $)") +
    xlab("Discharge Year") +
    labs(title = graph_name) +
        geom_text(aes(label = round(total_inflation_adjusted_cost, digits = 1), x = factor(discharge_year), group = factor(total_vent_support, levels = c("both", "invasive", "noninvasive", "none"))), position = position_stack(vjust = 0.5), size = 3) +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5)) +
    theme(plot.caption = element_text(hjust = 0.5))

  return(yearly_plot)
}

bea_gdp_annual_primary <- yearly_graph_function(primary_bronchiolitis_diagnoses, bea_gdp, "Inflation-Adjusted Cost of Care")

rm(yearly_graph_function)

cost_per_patient_function <- function(bronchiolitis_table, adjustment_table, graph_name) {
  temp_adjustment_table <- adjustment_table %>% dplyr::select(discharge_year, dollars_2010)
  temp_table <- left_join(bronchiolitis_table, temp_adjustment_table, by = "discharge_year")
  temp_table <- temp_table %>% mutate(inflation_adjusted_cost = adj_estimated_cost / dollars_2010)

  temp_delta <- summary(lm(inflation_adjusted_cost ~ discharge_year, data = subset(temp_table, total_vent_support == "none")))$coefficients[2, 1]
  temp_p <- summary(lm(inflation_adjusted_cost ~ discharge_year, data = subset(temp_table, total_vent_support == "none")))$coefficients[2, 4]

  temp_plot <- temp_table %>%
    group_by(discharge_year, .add = TRUE) %>%
    ggplot(mapping = aes(x = factor(discharge_year), y = inflation_adjusted_cost)) +
    geom_boxplot(outlier.colour = NA, fill = "gray60", notch = TRUE) +
    coord_cartesian(ylim = c(0, 25000)) +
    xlab("Discharge Year") +
    ylab("Admission Cost ($)") +
    labs(title = graph_name) +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5)) +
    theme(plot.subtitle = element_text(hjust = 0.5))

  return(temp_plot)
}

per_patient_bea_gdp_primary <- cost_per_patient_function(primary_bronchiolitis_diagnoses, bea_gdp, "Inflation Adjusted Cost of Care Per Patient")

rm(cost_per_patient_function)

```

```{r bea gdp annual plots, results="markup"}
bea_gdp_annual_primary
ggsave("Manuscript_Figures//Figure_3.tiff")
```


